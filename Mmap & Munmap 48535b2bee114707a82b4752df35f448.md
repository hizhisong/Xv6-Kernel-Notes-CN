# Mmap & Munmap

Status: Completed
æ¿å—: å†…å­˜ç®¡ç†

[mmap - Wikipedia](https://en.wikipedia.org/wiki/Mmap)

[https://man7.org/linux/man-pages/man2/mmap.2.html](https://man7.org/linux/man-pages/man2/mmap.2.html)

[è®¤çœŸåˆ†æmmapï¼šæ˜¯ä»€ä¹ˆ ä¸ºä»€ä¹ˆ æ€ä¹ˆç”¨](https://www.cnblogs.com/huxiao-tee/p/4660352.html)

[mmapè¯¦è§£](https://nieyong.github.io/wiki_cpu/mmap%E8%AF%A6%E8%A7%A3.html)

# mmapåŸå‹

  mmapæ˜¯ä¸€ç§å†…å­˜æ˜ å°„æ–‡ä»¶çš„æ–¹æ³•ï¼Œå³å°†ä¸€ä¸ªæ–‡ä»¶æˆ–è€…å…¶å®ƒå¯¹è±¡æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œå®ç°æ–‡ä»¶ç£ç›˜åœ°å€å’Œè¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ä¸€æ®µè™šæ‹Ÿåœ°å€çš„ä¸€ä¸€å¯¹æ˜ å…³ç³»ã€‚å®ç°è¿™æ ·çš„æ˜ å°„å…³ç³»åï¼Œè¿›ç¨‹å°±å¯ä»¥é‡‡ç”¨æŒ‡é’ˆçš„æ–¹å¼è¯»å†™æ“ä½œè¿™ä¸€æ®µå†…å­˜ï¼Œè€Œç³»ç»Ÿä¼š**è‡ªåŠ¨**å›å†™è„é¡µé¢åˆ°å¯¹åº”çš„æ–‡ä»¶ç£ç›˜ä¸Š(éå®æ—¶)ï¼Œå³å®Œæˆäº†å¯¹æ–‡ä»¶çš„æ“ä½œè€Œä¸å¿…å†è°ƒç”¨read,writeç­‰ç³»ç»Ÿè°ƒç”¨å‡½æ•°ã€‚ç›¸åï¼Œå†…æ ¸ç©ºé—´å¯¹è¿™æ®µåŒºåŸŸçš„ä¿®æ”¹ä¹Ÿç›´æ¥åæ˜ ç”¨æˆ·ç©ºé—´ï¼Œä»è€Œå¯ä»¥å®ç°ä¸åŒè¿›ç¨‹é—´çš„æ–‡ä»¶å…±äº«ã€‚

ä¿®æ”¹è¿‡çš„è„é¡µé¢å¹¶ä¸ä¼šç«‹å³æ›´æ–°å›æ–‡ä»¶ä¸­ï¼Œè€Œæ˜¯æœ‰ä¸€æ®µæ—¶é—´çš„å»¶è¿Ÿï¼Œå¯ä»¥è°ƒç”¨msync()æ¥å¼ºåˆ¶åŒæ­¥, è¿™æ ·æ‰€å†™çš„å†…å®¹å°±èƒ½ç«‹å³ä¿å­˜åˆ°æ–‡ä»¶é‡Œäº†

![Untitled](Mmap%20&%20Munmap%2048535b2bee114707a82b4752df35f448/Untitled.png)

è¿™æ˜¯ä¸€ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œæˆ‘ä»¬å°†å¯¹è±¡/æ–‡ä»¶æ˜ å°„åˆ°æ ˆå’Œå †ä¹‹é—´çš„éƒ¨åˆ†

```c
void *mmap(void *addr, size_t length, int prot, int flags, int fd, off_t offset);
```

- **addr**: mapåˆ°å½“å‰è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­çš„ä½ç½®ï¼Œå¦‚æœå€¼ä¸ºNULLåˆ™å°†ç”±å†…æ ¸å†³å®šmapåˆ°å½“å‰è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­æŸå¤„å¹¶è¿”å›mapåˆ°çš„ä½ç½®åœ°å€
- å¦‚æœæ˜¯æœ‰æ–‡ä»¶mapåˆ°å†…å­˜ä¸­ï¼š
    - **fd**: è¢«mapåˆ°å†…å­˜ä¸­æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦
    - **offset**: ä»æ–‡ä»¶èµ·å§‹offsetå¤„å¼€å§‹mapï¼ˆoffset must be a multiple of the page size as returned by sysconf(_SC_PAGE_SIZE) ï¼‰
    - **length:** mapå…±lengthæ–‡ä»¶é•¿åº¦
    - **prot:** å¯¹mapåˆ°å†…å­˜ä¸­çš„å†…å®¹çš„æƒé™(ä¸èƒ½å’Œæ–‡ä»¶æ‰“å¼€æ—¶ç»™å®šæ‰“å¼€æ–‡ä»¶æ¨¡å¼å†²çª)
        - **PROT_EXEC**  Pages may be executed.
        - **PROT_READ**  Pages may be read.
        - **PROT_WRITE** Pages may be written.
        - **PROT_NONE**  Pages may not be accessed.
        å‰ä¸‰ä¸ªé€šè¿‡ORç›¸è¿
- **flags**
    
    flagså†³å®šï¼šmapå†…å­˜åŒºåŸŸçš„æ›´æ–°å¯¹å…¶ä»–mapåˆ°è¿™ç‰‡åŒºåŸŸçš„è¿›ç¨‹æ˜¯å¦å¯è§ã€æ›´æ–°æ˜¯å¦å†™å…¥åˆ°åº•å±‚ä¾èµ–æ–‡ä»¶
    
    - **MAP_SHARED** mapå†…å­˜åŒºåŸŸçš„æ›´æ–°å¯¹å…¶ä»–mapåˆ°è¿™ç‰‡åŒºåŸŸçš„è¿›ç¨‹**å¯è§**ã€å¦‚æœæ˜¯æœ‰æ–‡ä»¶æ”¯æŒ(file-backed) çš„mappingï¼Œæ›´æ–°å¯¹æ–‡ä»¶å†™å…¥(msyncåŒæ­¥åˆ°æ–‡ä»¶)
    - **MAP_PRIVATE** Create a private **copy-on-write** mappingï¼Œåˆå§‹æœªä¿®æ”¹æ—¶å…±äº«æ˜ å°„ï¼Œä¸€æ—¦æŸä¸ªè¿›ç¨‹å¯¹æ˜ å°„çš„æŸä¸ªPageåšå‡ºä¿®æ”¹ï¼Œåˆ™é©¬ä¸Šæ‰§è¡ŒCOWï¼Œå¯¹ä¿®æ”¹çš„è¿›ç¨‹åˆ†é…ä¸€ä¸ªæ–°é¡µå¹¶copyåŸå†…å®¹è¿›æ¥å†åšå‡ºä¿®æ”¹ï¼Œä¸”ä¸å¯å¯¹å…¶ä»–mapè¿™ä¸ªfileçš„è¿›ç¨‹å¯è§ï¼Œå¦‚æœæ˜¯æœ‰æ–‡ä»¶æ”¯æŒ(file-backed) çš„mappingï¼Œæ›´æ–°ä¸å¯¹æ–‡ä»¶å†™å…¥ã€‚**æ–‡ä»¶åœ¨mapåè¢«æ”¹å˜çš„è¯æ²¡æœ‰è¯´æ˜æ˜¯å¦å¯¹mapå¯è§**
    - ...
    
    ## Privateï¼ŸSharedï¼Ÿ
    
    <aside>
    ğŸ’¡ * å¯¹äº**MAP_PRIVATE**çš„mmapä¼šè¦æ±‚**é¢„ç•™**æŒ‡å®šçš„æ–‡ä»¶å¤§å°å†…å­˜çš„ï¼Œå› ä¸ºä¼šæœ‰COWï¼Œå› æ­¤ä½ mmapçš„æ–‡ä»¶/å¯¹è±¡å¤§å°ä¸èƒ½**è¿œè¿œå¤§äºphysical ram + swap**
    * å¯¹äº**MAP_SHARED**çš„mmap**ä¸è¦æ±‚é¢„ç•™**å†…å­˜å¤§å°ï¼Œå¯¹MAP_SHAREDçš„å†™ä¼šåŠæ—¶åœ°åˆ·å…¥diskå¹¶åœ¨å†…å­˜ä¸­è‡ªåŠ¨å›æ”¶é‡Šæ”¾ç›¸å…³ç©ºé—´
    
    </aside>
    
    ```c
    #include <stdio.h>
    #include <stdlib.h>
    #include <stdint.h>
    #include <sys/mman.h>
    #include <sys/types.h>
    #include <sys/stat.h>
    #include <fcntl.h>
    
    #define handle_error(msg) \
      do { perror(msg); exit(EXIT_FAILURE); } while (0)
    
    int main(int argc, char *argv[])
    {
       const char *memblock;
       int fd;
       struct stat sb;
    
       fd = open(argv[1], O_RDWR);
       fstat(fd, &sb);
       printf("Size: %lu\n", (uint64_t)sb.st_size);
    
       memblock = mmap(NULL, sb.st_size, PROT_WRITE, MAP_PRIVATE, fd, 0);
       if (memblock == MAP_FAILED) handle_error("mmap");
    
       for(uint64_t i = 0; i < 10; i++)
       {
         printf("[%lu]=%X ", i, memblock[i]);
       }
       printf("\n");
       return 0;
    }
    ```
    
    å®éªŒç¯å¢ƒï¼š16G RAM + 2G Swapfile
    
    å¯¹äºPrivateä¸€ä¸ª16.5Gæ–‡ä»¶æ˜¯OKçš„
    
    ![Untitled](Mmap%20&%20Munmap%2048535b2bee114707a82b4752df35f448/Untitled%201.png)
    
    å¦‚æœè¿™ä¸ªPrivateæ˜ å°„æ–‡ä»¶å¤ªå¤§åˆ™ä¼šï¼š
    
    ![Untitled](Mmap%20&%20Munmap%2048535b2bee114707a82b4752df35f448/Untitled%202.png)
    
    å¦‚æœå°†mmapæ¨¡å¼æ”¹ä¸ºshared
    
    ![Untitled](Mmap%20&%20Munmap%2048535b2bee114707a82b4752df35f448/Untitled%203.png)
    
    ä¸€ä¸ª30Gæ–‡ä»¶è¢«æˆåŠŸmap
    

```c
int munmap(void *addr, size_t length);
```

The munmap() system call deletes the mappings for the specified address
range,  and  causes further references to addresses within the range to
generate invalid memory references.  The region is  also  automatically
unmapped  when  the  process is terminated.  On the other hand, **closing
the file descriptor does not unmap the region**.

The address addr must be a multiple of the page size (but  length  need
not  be).   All  pages containing a part of the indicated range are unâ€
mapped, and subsequent references to these pages will generate SIGSEGV.
It  is  not an error if the indicated range does not contain any mapped pages.

# Mmapæ€ä¹ˆä½¿ç”¨ï¼Ÿæœ‰ä»€ä¹ˆåœºæ™¯ï¼Ÿ

å°±ä¸¤ä¸ªï¼š

- æ˜ å°„ä¸€ä¸ªæœ‰åæ–‡ä»¶ï¼Œéœ€è¦æä¾›æ–‡ä»¶æè¿°ç¬¦ï¼Œä¸€å®šåœºæ™¯å¯ä½œä¸ºreadã€writeæ›¿ä»£å“ï¼Œä¸ä½¿ç”¨readã€writeå°±å¯ä»¥è¯»å†™diskä¸­å†…å®¹
- ç”¨æ¥æ˜ å°„åŒ¿åçš„å†…å­˜ï¼Œè¿™æ˜¯sbrk(malloc)çš„æ›¿ä»£æ–¹æ¡ˆ

|  | ç§æœ‰æ˜ å°„
å°†æ•°æ®æºæ‹·è´å‰¯æœ¬ï¼Œä¸å½±å“å…¶ä»–è¿›ç¨‹ | å…±äº«æ˜ å°„
å…±äº«çš„è¿›ç¨‹éƒ½èƒ½çœ‹åˆ° |
| --- | --- | --- |
| åŒ¿åæ˜ å°„
æ²¡æœ‰æ–‡ä»¶å¯¹åº”çš„åŒºåŸŸæ˜ å°„ï¼Œå†…å®¹å­˜æ”¾åœ¨ç‰©ç†å†…å­˜ä¸Šï¼› | ç§æœ‰åŒ¿åæ˜ å°„(é€šå¸¸ç”¨äºå†…å­˜åˆ†é…ï¼Œé€šå¸¸åˆ†é…å¤§å—å†…å­˜æ—¶ä½¿ç”¨ï¼Œå †ï¼Œæ ˆï¼Œbssæ®µç­‰)ï¼Œå½“ä½¿ç”¨å¤§äº128Kå†…å­˜æ—¶ fd = -1 ä¸” flags = MAP_ANONYMOUSï½œMAP_PRIVATE | å…±äº«åŒ¿åæ˜ å°„(é€šå¸¸ç”¨äºçˆ¶å­è¿›ç¨‹é—´å…±äº«) fd = -1 ä¸” flags = MAP_ANONYMOUSï½œMAP_SHARED |
| æ–‡ä»¶æ˜ å°„
å°†æ–‡ä»¶åŒºåŸŸæ˜ å°„åˆ°è¿›ç¨‹ç©ºé—´ï¼Œæ–‡ä»¶å­˜æ”¾åœ¨å­˜å‚¨è®¾å¤‡ä¸Š | ç§æœ‰æ–‡ä»¶æ˜ å°„(é€šå¸¸ç”¨äºåŠ¨æ€åº“ï¼Œä»£ç æ®µï¼Œæ•°æ®æ®µç­‰åŠ è½½) | å…±äº«æ–‡ä»¶æ˜ å°„(é€šå¸¸ç”¨äºå†…å­˜æ˜ å°„IO(æ–‡ä»¶è¯»å†™)ã€è¿›ç¨‹é—´é€šä¿¡) |

[Mmap() an entire large file](https://stackoverflow.com/questions/7222164/mmap-an-entire-large-file)

```c
#include <sys/types.h>
#include <sys/mman.h>
#include <err.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

/* This example shows how an mmap of /dev/zero is equivalent to
   using anonymous memory (MAP_ANON) not connected to any file.
   N.B. MAP_ANONYMOUS or MAP_ANON are supported by most UNIX
   versions, removing the original purpose of /dev/zero.
*/
int main(void)
{
        const char str1[] = "string 1";
        const char str2[] = "string 2";
        pid_t parpid = getpid(), childpid;
        int fd = -1;
        char *anon, *zero;

        if ((fd = open("/dev/zero", O_RDWR, 0)) == -1)
                err(1, "open");

        anon = (char*)mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_ANON|MAP_SHARED, -1, 0);
        zero = (char*)mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_SHARED, fd, 0);

        if (anon == MAP_FAILED || zero == MAP_FAILED)
                errx(1, "either mmap");

        strcpy(anon, str1);
        strcpy(zero, str1);

        printf("PID %d:\tanonymous %s, zero-backed %s\n", parpid, anon, zero); // 1
        switch ((childpid = fork())) {
        case -1:
                err(1, "fork");
                /* NOTREACHED */
        case 0:
                childpid = getpid();
                printf("PID %d:\tanonymous %s, zero-backed %s\n", childpid, anon, zero); // 2
                sleep(3);

                printf("PID %d:\tanonymous %s, zero-backed %s\n", childpid, anon, zero); // 4
                munmap(anon, 4096);
                munmap(zero, 4096);
                close(fd);
                return EXIT_SUCCESS;
        }

        sleep(2);
        strcpy(anon, str2);
        strcpy(zero, str2);

        printf("PID %d:\tanonymous %s, zero-backed %s\n", parpid, anon, zero); // 3
        munmap(anon, 4096);
        munmap(zero, 4096);
        close(fd);
        return EXIT_SUCCESS;
}
```

```c
PID 22475:      anonymous string 1, zero-backed string 1
PID 22476:      anonymous string 1, zero-backed string 1
PID 22475:      anonymous string 2, zero-backed string 2
PID 22476:      anonymous string 2, zero-backed string 2
```

# Mmapå®ç°

![Untitled](Mmap%20&%20Munmap%2048535b2bee114707a82b4752df35f448/Untitled%204.png)

# Mmapæœ‰ä»€ä¹ˆå¥½çš„ï¼Ÿ-- ä¸ä½¿ç”¨read() write()

<aside>
ğŸ’¡ ä¸ä½¿ç”¨ read() write()
ä¸ä½¿ç”¨copy_from() copy_to()

</aside>

1. Mmapå¯¹æ–‡ä»¶èƒ½è¿›è¡Œç”¨æˆ·ç©ºé—´çš„å¯»å€
    
    å®ç°äº†ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„é«˜æ•ˆäº¤äº’æ–¹å¼ã€‚ä¸¤ç©ºé—´çš„å„è‡ªä¿®æ”¹æ“ä½œå¯ä»¥ç›´æ¥åæ˜ åœ¨æ˜ å°„çš„åŒºåŸŸå†…ï¼Œä»è€Œè¢«å¯¹æ–¹ç©ºé—´åŠæ—¶æ•æ‰ã€‚
    
2. mmap() ç³»ç»Ÿè°ƒç”¨å‡½æ•°ä¼šç›´æ¥æŠŠ**å†…æ ¸ç¼“å†²åŒº**é‡Œçš„æ•°æ®ã€Œ**æ˜ å°„**ã€åˆ°ç”¨æˆ·ç©ºé—´ï¼Œè¿™æ ·ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸ä¸ç”¨æˆ·ç©ºé—´å°±ä¸éœ€è¦å†è¿›è¡Œä»»ä½•çš„æ•°æ®æ‹·è´æ“ä½œ
    
    **èŠ‚çœäº†ä¸€æ¬¡æ‹·è´**
    
    ![Untitled](Mmap%20&%20Munmap%2048535b2bee114707a82b4752df35f448/Untitled%205.png)
    
    **åº”â½¤è¿›ç¨‹è°ƒâ½¤äº† mmap() åï¼Œ DMA ä¼šæŠŠç£ç›˜çš„æ•°æ®æ‹·â»‰åˆ°å†…æ ¸çš„ç¼“å†²åŒºâ¾¥ã€‚æ¥ç€ï¼Œåº”â½¤è¿›ç¨‹è·Ÿæ“ä½œç³»ç»Ÿå†…æ ¸ã€Œå…±äº«ã€è¿™ä¸ªç¼“å†²åŒºï¼›**
    
    ç”¨æˆ·è¿›ç¨‹æ”¹å†™äº† å†…æ ¸-ç”¨æˆ·è¿›ç¨‹å…±äº« çš„ç¼“å†²åŒºåï¼Œå†…æ ¸æ€ä¼šå®šæœŸ/ä½¿èƒ½å°†è¯¥åœ¨å†…æ ¸æ€çš„ç¼“å†²åŒºå†™å›ç£ç›˜
    
    ä½†ä¹Ÿå¯èƒ½åƒå›¾ä¸­ä¸€æ ·æ‹·è´åˆ°å…¶ä»–å†…æ ¸ç¼“å†²åŒºä¸­ï¼ˆåº”â½¤è¿›ç¨‹å†è°ƒâ½¤ write() ï¼Œæ“ä½œç³»ç»Ÿç›´æ¥å°†å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®æ‹·â»‰åˆ° socket ç¼“å†²åŒºä¸­ï¼Œè¿™â¼€åˆ‡éƒ½å‘â½£åœ¨å†…æ ¸æ€ï¼Œç”± CPU æ¥æ¬è¿æ•°æ®ï¼‰
    
    **æ³¨æ„ï¼šè¿™é‡ŒMmapæ˜ å°„çš„å†…æ ¸ç¼“å†²åŒº ä»£æ›¿äº† å†…æ ¸ä¸­çš„ç¡¬ç›˜é¡µç¼“å­˜ï¼ˆBuffer Cacheï¼‰**
    
3. ä¹Ÿç®—æ˜¯è¿›ç¨‹é—´é€šä¿¡çš„æ–¹å¼

# MmapåŠ£åŠ¿ï¼Ÿ

1. **æ— æ³•æ˜ å°„å˜é•¿æ–‡ä»¶**ï¼šè°ƒç”¨mmap()æ—¶éœ€æŒ‡å®šè¦æ˜ å°„çš„æ–‡ä»¶ä½ç½®å’Œéœ€è¦æ˜ å°„çš„å¤§å°èŒƒå›´ã€‚
2. å¦‚æœéœ€è¦æ˜ å°„çš„æ–‡ä»¶è¿‡å¤§ï¼Œä¼šå¯¼è‡´è¿‡åº¦å ç”¨è™šæ‹Ÿå†…å­˜ï¼šåœ¨è°ƒç”¨mmap()åï¼Œè™šæ‹Ÿå†…å­˜ç©ºé—´å°±åˆ›å»ºäº†ï¼Œæ­¤æ—¶è™½ç„¶ä¸ä¼šå ç”¨ç‰©ç†å†…å­˜ï¼Œä½†ä¾ç„¶ä¼šå ç”¨è™šæ‹Ÿå†…å­˜ã€‚æ­¤æ—¶å¯è€ƒè™‘åªæ˜ å°„æ–‡ä»¶ä¸­è‡ªå·±éœ€è¦çš„éƒ¨åˆ†ã€‚

ç”±æ­¤ï¼Œå½“æˆ‘ä»¬éœ€è¦è®¿é—®ä¸€ä¸ªæ¯”è¾ƒå¤§çš„æ–‡ä»¶ï¼Œå°¤å…¶æ˜¯å½“æˆ‘ä»¬åªéœ€è¦è®¿é—®å…¶ä¸­çš„ä¸€å°éƒ¨åˆ†æ•°æ®çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•é€šè¿‡ mmap çš„æ–¹å¼æ¥è¿›è¡Œè®¿é—®ï¼Œå‡å°‘ç”±äºè¯¥æ–‡ä»¶è¿‡å¤§è€Œå¯¹ç‰©ç†å†…å­˜çš„è¿‡åº¦å ç”¨ã€‚