# Trap

Status: Completed
æ¿å—: Trap

# **Trapæœºåˆ¶ -- interrupt å’Œ exception**

## 1. **Mindmap -- åˆ†ç±»**

## interrupt

an external **asynchronousã€å¼‚æ­¥ã€‘** event that may cause a RISC-V hart to experience an unexpected transfer of control

## exception

an unusual condition occurring at run time associated with an instruction in the current RISC-V hart ã€åŒæ­¥çš„ã€‘

![[https://github.com/riscv/riscv-isa-manual/releases/download/Ratified-IMAFDQC/riscv-spec-20191213.pdf](https://github.com/riscv/riscv-isa-manual/releases/download/Ratified-IMAFDQC/riscv-spec-20191213.pdf)](Trap%204591d26b99d04fb9b9e858b19bcd61ee/Untitled.png)

[https://github.com/riscv/riscv-isa-manual/releases/download/Ratified-IMAFDQC/riscv-spec-20191213.pdf](https://github.com/riscv/riscv-isa-manual/releases/download/Ratified-IMAFDQC/riscv-spec-20191213.pdf)

![syscallä¹Ÿç®—æ˜¯exceptionçš„ä¸€ç§](Trap%204591d26b99d04fb9b9e858b19bcd61ee/image1.png)

syscallä¹Ÿç®—æ˜¯exceptionçš„ä¸€ç§

![Untitled](Trap%204591d26b99d04fb9b9e858b19bcd61ee/Untitled%201.png)

## 2. **å¯„å­˜å™¨**

### **RISC-V calling convention register usage ç”¨æˆ·å¯„å­˜å™¨**

![Trap%204591d26b99d04fb9b9e858b19bcd61ee/image3.png](Trap%204591d26b99d04fb9b9e858b19bcd61ee/image3.png)

æ¯ä¸ªCPUéƒ½æœ‰**32ä¸ªç”¨æˆ·å¯„å­˜å™¨ï¼ˆè¡¨æ ¼ä¸ŠåŠéƒ¨ï¼‰**ï¼Œç”¨æˆ·åº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨å…¨éƒ¨çš„å¯„å­˜å™¨ï¼Œå¹¶ä¸”ä½¿ç”¨å¯„å­˜å™¨çš„æŒ‡ä»¤æ€§èƒ½æ˜¯æœ€å¥½çš„ã€‚

**GDBä¸­å¯ä»¥ä½¿ç”¨info regæ‰“å°32ä¸ªç”¨æˆ·å¯„å­˜å™¨**

                         **<uservec()ä¼šä¿å­˜æ‰€æœ‰çš„è¿™32ä¸ªç”¨æˆ·å¯„å­˜å™¨è¿›trapframe>**

![Untitled](Trap%204591d26b99d04fb9b9e858b19bcd61ee/Untitled%202.png)

### **å‡ ä¸ªç‰¹æ®ŠåŠŸèƒ½çš„å¯„å­˜å™¨ (Overview)**

ç¨‹åºè®¡æ•°å™¨PC å¯„å­˜å™¨(Program Counter Register)

stack pointer SP

ä¸€å †æ§åˆ¶CPUå·¥ä½œæ–¹å¼çš„å¯„å­˜å™¨ -- i.e. satp(æ ¹é¡µè¡¨åœ°å€)å¯„å­˜å™¨

STVECï¼ˆSupervisor Trap Vector Base Address Registerï¼‰å¯„å­˜å™¨ï¼Œè¿™æ˜¯ä¸€ä¸ªåªèƒ½åœ¨supervisor modeä¸‹è¯»å†™çš„ç‰¹æƒå¯„å­˜å™¨ï¼Œå®ƒæŒ‡å‘äº† **å†…æ ¸ä¸­ å¤„ç†trap**çš„æŒ‡ä»¤çš„**èµ·å§‹åœ°å€**ï¼Œåœ¨é€€å‡ºtrapåˆ°ç”¨æˆ·ç©ºé—´æ—¶è®¾ç½®ä¸ºuservecï¼Œè¿›å…¥åˆ°å†…æ ¸trapä¸­è®¾ç½®ä¸ºkernelvec

SEPCï¼ˆSupervisor Exception Program Counterï¼‰å¯„å­˜å™¨ï¼Œåœ¨ trapçš„è¿‡ç¨‹ ä¸­ ä¿å­˜è¿›å…¥trapå‰ç”¨æˆ·ç¨‹åºè®¡æ•°å™¨ çš„å€¼(ç¡¬ä»¶æ¥ä¿å­˜)

SSCRATCHï¼ˆSupervisor Scratch Registerï¼‰å¯„å­˜å™¨è®°å½•ç€è¿™ä¸ªè¿›ç¨‹çš„trapframeåœ°å€ã€‚ä¿å­˜ç°åœºæ—¶ï¼Œéœ€è¦å°†ä¸ªç”¨æˆ·32å¯„å­˜å™¨ä¿å­˜åœ¨trapframeä¸Šã€‚

scauseè®°å½•è¿™ä¸ªtrapçš„å‘ç”ŸåŸå› ã€‚å½“trapå‘ç”Ÿæ—¶ï¼Œè¿™ä¸ªå¯„å­˜å™¨è¢«è®¾ç½®

sstatutsçš„SPPä½è®°å½•ç€å½“å‰CPUæ‰€å¤„çš„modeã€‚

# Trapæœºåˆ¶æµç¨‹

## **Shellä¸­è°ƒç”¨writeç³»ç»Ÿè°ƒç”¨**

![Trap%204591d26b99d04fb9b9e858b19bcd61ee/image4.jpeg](Trap%204591d26b99d04fb9b9e858b19bcd61ee/image4.jpeg)

**ç”±äºå°†CPUæ‰§è¡Œæƒäº¤ç”±å†…æ ¸ç¨‹åºå¤„ç†ï¼Œå†…æ ¸ç¨‹åºéœ€è¦ä¾µå 32ä¸ªå¯„å­˜å™¨ï¼Œé¡µè¡¨ç­‰èµ„æºï¼Œå› æ­¤Trapä¹Ÿè¦å¤„ç†è¿™äº›é—®é¢˜**

## **Trapframe**

### **ä»€ä¹ˆæ˜¯trapframe**

å½“åˆ›å»ºæ¯ä¸ªè¿›ç¨‹æ—¶ï¼Œxv6ä¸ºè¿›ç¨‹çš„trapframeåˆ†é…ä¸€é¡µå†…å­˜ï¼Œå¹¶å°†å®ƒæ˜ å°„åœ¨ç”¨æˆ·è™šæ‹Ÿåœ°å€TRAPFRAMEï¼Œä¹Ÿå°±æ˜¯TRAMPOLINEçš„ä¸‹é¢ï¼Œè¿›ç¨‹çš„p->trapframeä¹ŸæŒ‡å‘trapframeï¼Œä¸è¿‡æ˜¯æŒ‡å‘å®ƒçš„ç‰©ç†åœ°å€(å†…æ ¸ä¸­ç‰©ç†åœ°å€å’Œè™šæ‹Ÿåœ°å€æ—¶ç›´æ¥æ˜ å°„çš„ï¼Œæ‰€ä»¥å¯ä»¥åœ¨å¯ç”¨åˆ†é¡µæ—¶ï¼Œé€šè¿‡ç‰©ç†åœ°å€è®¿é—®)ï¼Œè¿™æ ·å†…æ ¸å¯ä»¥é€šè¿‡å†…æ ¸é¡µè¡¨æ¥ä½¿ç”¨å®ƒ

å› æ­¤ï¼Œåœ¨äº¤æ¢a0å’Œsscratchåï¼Œa0å°†æŒ‡å‘å½“å‰è¿›ç¨‹çš„trapframeã€‚uservec å°†åœ¨trapframeä¿å­˜å…¨éƒ¨çš„å¯„å­˜å™¨ï¼ŒåŒ…æ‹¬ä»sscratchè¯»å–çš„a0ã€‚

### **ä¸ºä»€ä¹ˆæŠŠç”¨æˆ·å¯„å­˜å™¨ä¿å­˜åœ¨ç”¨æˆ·è™šæ‹Ÿå†…å­˜ä¸­çš„trapframeè€Œä¸æ˜¯ç”¨æˆ·æ ˆä¸­ï¼Ÿ**

å› ä¸ºæœ‰äº›è¯­è¨€æ²¡æœ‰æ ˆè¿™ä¸ªæ¦‚å¿µï¼Œstack pointer (SP)ä¸æŒ‡å‘ä»»ä½•åœ°å€

æˆ–è€…æœ‰äº›ç¼–ç¨‹è¯­è¨€æœ‰æ ˆï¼Œä½†æ ¼å¼å¾ˆå¥‡æ€ªï¼Œå†…æ ¸ä¸èƒ½ç†è§£ï¼Œä¾‹å¦‚ç¼–ç¨‹è¯­è¨€ç”¨å †ä¸­å°å—å†…å­˜ä½œä¸ºæ ˆè€Œå†…æ ¸å´ä¸çŸ¥é“ç¼–ç¨‹è¯­è¨€çŸ¥é“

## **Trapä»£ç æ‰§è¡Œæµç¨‹ -- ä»ç”¨æˆ·ç©ºé—´åˆ‡æ¢åˆ°å†…æ ¸çš„ä¸€ä¸ªä½ç½®ï¼Œè¿è¡Œå†…æ ¸çš„Cä»£ç **

### **Overview**

Trapå¼€å§‹å‰ï¼ŒCPUæ‰§è¡ŒæŒ‡ä»¤çš„çŠ¶æ€è¿˜æ˜¯ç”¨æˆ·ä»£ç æ¨¡å¼(User mode)ï¼Œè¦ä½¿CPUæ”¹å˜çŠ¶æ€ï¼Œæ‰§è¡Œç›¸å…³ç³»ç»Ÿä»£ç ï¼Œæ‰§è¡Œç‰¹æƒæŒ‡ä»¤éœ€è¦å¯¹ç°æœ‰çŠ¶æ€è¿›è¡Œä¸€äº›æ“ä½œ

**å¯åŠ¨ç³»ç»Ÿä¸Šç”µä»machine mode->superisor mode -> user modeæ—¶(ç¬¬ä¸€æ¬¡è®¾ç½®) å’Œ ä¸Šæ¬¡é€€å‡ºtrapæ—¶å†…æ ¸è®¾ç½® ä¸‹åˆ—å¯„å­˜å™¨ï¼š**

1. è®¾ç½®**sscratch**å¯„å­˜å™¨ä¸ºuser page tableä¸­çš„ trapframe åœ°å€ï¼ˆè¡¨æ˜è¿›å…¥å†…æ ¸æ€æ—¶å†…æ ¸æŠŠç”¨æˆ·å¯„å­˜å™¨ä¿å­˜åˆ°ç”¨æˆ·é¡µè¡¨çš„å“ªé‡Œï¼Œå€¼ä¸º0x3fffffe000 = Trampoline - PGSIZE = MAXVE - PGSIZE - PGSIZEï¼‰
2. è®¾ç½®**stvec**å¯„å­˜å™¨ä¸ºuser page tableä¸­çš„trampolineèµ·å§‹åœ°å€(å³uservecåœ°å€ ç”¨äºå¤„ç†trapçš„æ±‡ç¼–)
    
    ...åœ¨usertrapret()å¯ä»¥çœ‹
    

**æœ‰äº†ä¸Šè¿°ä¸¤æ­¥çš„ä¿è¯ï¼Œä¸‹æ¥è¿›å…¥Trapå°±æœ‰äº†è·¯å­å¯èµ°**

---

===== æ‰§è¡Œecallï¼Œecallåšä¸¤ä»¶äº‹ï¼š<**ç¡¬ä»¶è¡Œä¸º**>====

1. User Mode --> **Supervisor Mode** ï¼ˆ**ç‰¹æƒä½**ï¼‰ ï¼ˆä¸‹ä¸€æ­¥åå¯ä»¥é€šè¿‡æŸ¥çœ‹ç¨‹åºè®¡æ•°å™¨ç°åœ¨æ­£åœ¨trampoline pageæ‰§è¡Œä»£ç ï¼Œè€Œè¿™äº›pageå¯¹åº”çš„PTEå¹¶æ²¡æœ‰è®¾ç½®PTE_uæ ‡å¿—ä½ï¼‰
2. å°†ç”¨æˆ·ç¨‹åºç¨‹åºè®¡æ•°å™¨**PC**çš„å€¼ä¿å­˜åœ¨äº†**SEPC(Supervisor Exception Program Counter)**å¯„å­˜å™¨ï¼Œæ¥ç€å°† PC è®¾ç½®æˆäº†STVECä¸­çš„**trampoline pageåœ°å€** (ä½äºç”¨æˆ·è™šæ‹Ÿå†…å­˜ä¸­ç”¨æ¥è¿›å…¥å†…æ ¸çš„è¹¦åºŠ)ï¼Œæ¥ç€ä»PCè¿™é‡Œæ‰§è¡ŒæŒ‡ä»¤ --- **Trapï¼šä»–ï¼Œæ”¹å˜äº†PC**

======== ecall ä¹‹å ========== <**ä¹‹å‰å‡ä¸ºCPUç¡¬ä»¶è¡Œä¸º>**

1. **ä¿å­˜32ä¸ªç”¨æˆ·å¯„å­˜å™¨** (å†…æ ¸è¦ä½¿ç”¨è¿™32ä¸ªå¯„å­˜å™¨ä½†åç»­åˆè¦å®ç°æ— æ„ŸçŸ¥åœ°æ¢å¤ç”¨æˆ·ä»£ç çš„æ‰§è¡Œ)
2. å°†**SATP**æŒ‡å‘**kernel page table** (user page tableåªåŒ…å«äº†ç”¨æˆ·ç¨‹åºæ‰€éœ€è¦çš„å†…å­˜æ˜ å°„å’Œä¸€ä¸¤ä¸ªå…¶ä»–çš„æ˜ å°„ï¼Œå®ƒå¹¶æ²¡æœ‰åŒ…å«æ•´ä¸ªå†…æ ¸æ•°æ®çš„å†…å­˜æ˜ å°„)
    
    æ‰§è¡Œecallåï¼Œecallä¸ä¼šåˆ‡æ¢é¡µè¡¨ï¼Œæˆ‘ä»¬è¦åœ¨ç”¨æˆ·é¡µè¡¨ä¸­æŸä¸ªä½ç½®æ‰§è¡Œå†…æ ¸çš„first bitï¼Œè¿™ä¸ªä½ç½®å°±æ˜¯ç”¨æˆ·é¡µè¡¨ä¸­trampoline pageï¼Œè¿™ç»™äº†å†…æ ¸åœ¨ç”¨æˆ·é¡µè¡¨ä¸‹å¯¹trapå¼€å§‹æ‰§è¡Œæ—¶çš„åˆå§‹ä½ç½®
    
3. æˆ‘ä»¬éœ€è¦åˆ›å»ºæˆ–è€…æ‰¾åˆ°ä¸€ä¸ª**kernel stack**ï¼Œå¹¶å°†Stack Pointerå¯„å­˜å™¨çš„å†…å®¹æŒ‡å‘é‚£ä¸ªkernel stackã€‚è¿™æ ·æ‰èƒ½ç»™Cä»£ç æä¾›æ ˆã€‚(éœ€è¦ä¸€ä¸ªå †æ ˆæ¥è°ƒç”¨å†…æ ¸çš„Cå‡½æ•°)
4. ä¸€åˆ‡åˆé€‚ï¼Œ**è·³å…¥å†…æ ¸çš„Cä»£ç ** (ä¸€æ—¦æˆ‘ä»¬è¿è¡Œåœ¨å†…æ ¸çš„Cä»£ç ä¸­ï¼Œé‚£å°±è·Ÿå¹³å¸¸çš„Cä»£ç æ˜¯ä¸€æ ·çš„)

trapå¤„ç†ä»£ç å¿…é¡»å­˜åœ¨äºæ¯ä¸€ä¸ªuser page tableä¸­ï¼Œå› ä¸ºecallå¹¶ä¸ä¼šåˆ‡æ¢page tableï¼Œæˆ‘ä»¬éœ€è¦åœ¨user page tableä¸­çš„æŸä¸ªåœ°æ–¹æ¥æ‰§è¡Œæœ€åˆçš„å†…æ ¸ä»£ç ã€‚è€Œè¿™ä¸ªtrampoline pageï¼Œæ˜¯ç”±å†…æ ¸å°å¿ƒçš„æ˜ å°„åˆ°æ¯ä¸€ä¸ªuser page tableä¸­ï¼Œä»¥ä½¿å¾—å½“æˆ‘ä»¬ä»ç„¶åœ¨ä½¿ç”¨user page tableæ—¶ï¼Œå†…æ ¸åœ¨ä¸€ä¸ªåœ°æ–¹èƒ½å¤Ÿæ‰§è¡Œtrapæœºåˆ¶çš„æœ€å¼€å§‹çš„ä¸€äº›æŒ‡ä»¤ã€‚

---

<aside>
ğŸ’¡ **ä¸Šè¿°æˆ‘ä»¬åˆ—ä¸¾äº†Ecallçš„è¯¦ç»†æµç¨‹ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æ›´ç»Ÿä¸€çš„Trapæ€ä¹ˆå¤„ç†**

</aside>

# **Xv6 trap å¤„ç†åˆ†ä¸ºå››ä¸ªé˜¶æ®µ**

1. CPUé‡‡å–ç¡¬ä»¶è¡Œä¸º
2. "æ±‡ç¼–ä»£ç "ä¸ºä¸‹ä¸€æ­¥C code å¤„ç†åšå‡†å¤‡(ä¸ºå†…æ ¸Cä»£ç å‡†å¤‡çš„æ±‡ç¼–å…¥å£)
3. C Trap Handler(å¤„ç†trapçš„C å¤„ç†ç¨‹åº)
    
    system call or device-driver service routine
    
4. æ¥è‡ªç”¨æˆ·ç©ºé—´çš„trapã€æ¥è‡ªå†…æ ¸ç©ºé—´çš„trapå’Œå®šæ—¶å™¨ä¸­æ–­ï¼Œè®¾ç½®å•ç‹¬çš„ æ±‡ç¼–å…¥å£ å’Œ C trapå¤„ç†ç¨‹åº

### **Trapç¬¬ä¸€é˜¶æ®µ -- CPUç¡¬ä»¶è¡Œä¸º**

1. **å¦‚æœè¯¥trapæ˜¯è®¾å¤‡ä¸­æ–­ï¼Œä¸”sstatus SIEä½ä¸º0ï¼Œé‚£ä¹ˆå°±ä¸è¦æ‰§è¡Œä»¥ä¸‹ä»»ä½•æ“ä½œã€‚**
2. é€šè¿‡æ¸…é™¤SIEæ¥**ç¦ç”¨ä¸­æ–­**ã€‚
3. **å¤åˆ¶pcåˆ°sepc**
4. å°†å½“å‰æ¨¡å¼(ç”¨æˆ·æˆ–ç›‘ç£è€…)ä¿å­˜åœ¨sstatusçš„SPPä½ã€‚
5. **åœ¨scauseè®¾ç½®è¯¥æ¬¡trapçš„åŸå› ã€‚**
6. **å°†æ¨¡å¼è½¬æ¢ä¸ºç›‘ç£è€…(S mode)ã€‚**
7. **å°†stvecå¤åˆ¶åˆ°pcã€‚**(**stvec**æŒ‡å‘çš„trapå¤„ç†ç¨‹åºåœ°å€ä¸º**uservec**åœ°å€ï¼Œç”±äºæ­¤æ—¶è¿˜ä¸ºç”¨æˆ·é¡µè¡¨ï¼Œå› æ­¤uservecåœ¨å†…æ ¸å’Œç”¨æˆ·é¡µè¡¨åœ°å€ä¸€æ ·ï¼Œå³trampolineé¡µ)
8. **æ‰§è¡Œæ–°çš„pc (uservec)**
    
    æ³¨æ„ï¼ŒCPUä¸ä¼šåˆ‡æ¢åˆ°å†…æ ¸é¡µè¡¨ï¼Œä¸ä¼šåˆ‡æ¢åˆ°å†…æ ¸ä¸­çš„æ ˆï¼Œä¹Ÿä¸ä¼šä¿å­˜pcä»¥å¤–çš„ä»»ä½•å¯„å­˜å™¨ã€‚å†…æ ¸è½¯ä»¶å¿…é¡»æ‰§è¡Œè¿™äº›ä»»åŠ¡ã€‚
    

### **ä¸­æ–­å¤„ç†ç¨‹åºè·¯å¾„ -- Trapç¬¬äºŒã€ä¸‰ã€å››è½¯ä»¶é˜¶æ®µ**

åœ¨ç”¨æˆ·ç©ºé—´æ‰§è¡Œæ—¶ï¼Œå¦‚æœç”¨æˆ·ç¨‹åºè¿›è¡Œäº†ç³»ç»Ÿè°ƒç”¨(**ecall**æŒ‡ä»¤)ï¼Œæˆ–è€…åšäº†ä¸€äº›éæ³•çš„äº‹æƒ…ï¼Œæˆ–è€…è®¾å¤‡ä¸­æ–­ï¼Œéƒ½å¯èƒ½å‘ç”Ÿtrapã€‚

1. æ¥è‡ªç”¨æˆ·ç©ºé—´çš„trapçš„å¤„ç†è·¯å¾„æ˜¯**uservec**(kernel/trampoline.S:16)
    - uservec: äº¤æ¢sscratchä¸a0ï¼Œä¹‹åa0å­˜ç€ç”¨æˆ·trapframeï¼Œå°†ç”¨æˆ·å¯„å­˜å™¨å…¨éƒ¨**å­˜**å‚¨åˆ°trapframe
    - ä»trapframeä¸­çš„ç”¨æˆ·å¯„å­˜å™¨ä¸­**è¯»**kernel stackã€hartidã€usertrapã€kernel pagetableåˆ°å†…æ ¸ä½¿ç”¨ç›¸åº”å¯„å­˜å™¨ä¸­
    - è·³è½¬åˆ°usertrapä¸è¿”å› (jr t0  (t0å­˜ç€usertrapå‡½æ•°çš„åœ°å€))
2. ç„¶åæ˜¯**usertrap**(kernel/trap.c:37)
    - ç¡®å®štrapçš„åŸå› ï¼Œå¯¹åº”åŸå› å¤„ç†å®ƒ(ä¾‹å¦‚å¯¹äºç³»ç»Ÿè°ƒç”¨æ‰§è¡Œ`syscall()`)ï¼Œè¿”å›
3. è¿”å›è·³è½¬åˆ°**usertrapret**(kernel/trap.c:90)
    - è®¾ç½®RISC-Væ§åˆ¶å¯„å­˜å™¨ï¼Œä¸ºä»¥åç”¨æˆ·ç©ºé—´trapåšå‡†å¤‡ï¼š
        
        æ”¹å˜**stvec**æ¥å¼•ç”¨**uservec**ï¼Œå‡†å¤‡**uservec**æ‰€ä¾èµ–çš„**trapframe**å­—æ®µï¼Œå¹¶å°†**sepc**è®¾ç½®ä¸ºå…ˆå‰ä¿å­˜çš„ç”¨æˆ·ç¨‹åºè®¡æ•°å™¨ï¼ˆåœ¨userretæ±‡ç¼–ä¸­ æœ€åçš„sretæŒ‡ä»¤å°†ç”¨æˆ·PCå€¼æ”¹ä¸ºsepcå€¼ï¼Œsepcåˆåœ¨æ­¤æ­¥è¢«è®¾ç½®ï¼‰ã€‚æœ€åï¼Œ**usertrapret**åœ¨ç”¨æˆ·é¡µè¡¨å’Œå†…æ ¸é¡µè¡¨ä¸­æ˜ å°„çš„trampolineé¡µä¸Šè°ƒç”¨**userret**ï¼Œå› ä¸º**userret**ä¸­çš„æ±‡ç¼–ä»£ç ä¼šåˆ‡æ¢é¡µè¡¨ï¼Œè¿™æ­¥è°ƒç”¨userretæ—¶å°†trapframeåœ°å€ä¿å­˜è‡³sscratchã€‚
        
4. ç„¶åæ˜¯**userret**(kernel/trampoline.S:16)
5. æ¢å¤trapframe(ç”¨æˆ·ç°åœº) è·³è½¬ç”¨æˆ·pc

---

## **æŠ˜å  -- GDBè·Ÿè¸ª**

**ä»ç”¨æˆ·ç©ºé—´åˆ‡æ¢åˆ°å†…æ ¸ç©ºé—´ç›¸å…³çš„å®‰å…¨é—®é¢˜**

trapä¸­æ¶‰åŠåˆ°çš„ ç¡¬ä»¶ å’Œ å†…æ ¸æœºåˆ¶ ä¸èƒ½ä¾èµ–ä»»ä½•æ¥è‡ªç”¨æˆ·ç©ºé—´ä¸œè¥¿ã€‚

æ¯”å¦‚è¯´æˆ‘ä»¬ä¸èƒ½ä¾èµ–32ä¸ªç”¨æˆ·å¯„å­˜å™¨ï¼Œå®ƒä»¬å¯èƒ½ä¿å­˜çš„æ˜¯æ¶æ„çš„æ•°æ®ï¼Œæ‰€ä»¥ï¼ŒXV6çš„trapæœºåˆ¶ä¸ä¼šæŸ¥çœ‹è¿™äº›å¯„å­˜å™¨ï¼Œè€Œåªæ˜¯å°†å®ƒä»¬ä¿å­˜èµ·æ¥

STVECå¯„å­˜å™¨æ˜¯ä¸€ä¸ªåªèƒ½åœ¨supervisor modeä¸‹è¯»å†™çš„ç‰¹æƒå¯„å­˜å™¨ã€‚åœ¨ä»å†…æ ¸ç©ºé—´è¿›å…¥åˆ°ç”¨æˆ·ç©ºé—´ä¹‹å‰ï¼Œå†…æ ¸ä¼šè®¾ç½®å¥½STVECå¯„å­˜å™¨æŒ‡å‘å†…æ ¸å¸Œæœ›trapä»£ç è¿è¡Œçš„ä½ç½®(trampoline pageçš„èµ·å§‹ä½ç½®)ã€‚

STVECå¯„å­˜å™¨çš„å†…å®¹ï¼Œå°±æ˜¯åœ¨ecallæŒ‡ä»¤æ‰§è¡Œä¹‹åï¼Œæˆ‘ä»¬ä¼šåœ¨è¿™ä¸ªç‰¹å®šåœ°å€æ‰§è¡ŒæŒ‡ä»¤çš„åŸå› ã€‚

å³ä½¿trampoline pageæ˜¯åœ¨ç”¨æˆ·åœ°å€ç©ºé—´çš„user page tableå®Œæˆçš„æ˜ å°„ï¼Œç”¨æˆ·ä»£ç ä¸èƒ½å†™å®ƒï¼Œå› ä¸ºè¿™äº›pageå¯¹åº”çš„PTEå¹¶æ²¡æœ‰è®¾ç½®PTE_uæ ‡å¿—ä½ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆtrapæœºåˆ¶æ˜¯å®‰å…¨çš„ã€‚

**modeæ ‡å¿—ä½**

è¡¨æ˜å½“å‰CPUæ‰§è¡ŒæŒ‡ä»¤çš„çŠ¶æ€æ˜¯user modeè¿˜æ˜¯supervisor mode

**supervisor modeä¸‹æ¯”user modeä¸‹èƒ½å¤šåšçš„ä¸¤ä»¶äº‹ï¼š**

**è¯»å†™ æ§åˆ¶å¯„å­˜å™¨** äº† -- åœ¨supervisor modeä½ å¯ä»¥è¯»å†™ä»¥ä¸‹è¿™äº›å¯„å­˜å™¨ï¼Œè€Œç”¨æˆ·ä»£ç ä¸èƒ½åšè¿™æ ·çš„æ“ä½œï¼š

å†™SATPå¯„å­˜å™¨ï¼ŒSTVECï¼Œä¹Ÿå°±æ˜¯å¤„ç†trapçš„å†…æ ¸æŒ‡ä»¤åœ°å€ï¼›SEPCï¼Œä¿å­˜å½“å‘ç”Ÿtrapæ—¶çš„ç¨‹åºè®¡æ•°å™¨ï¼›SSCRATCHç­‰ç­‰

å®ƒ**å¯ä»¥ä½¿ç”¨PTE_Uæ ‡å¿—ä½ä¸º0çš„PTE**

(PTE_Uæ ‡å¿—ä½ä¸º1çš„æ—¶å€™ï¼Œè¡¨æ˜ç”¨æˆ·ä»£ç å¯ä»¥ä½¿ç”¨è¿™ä¸ªé¡µè¡¨ï¼›å¦‚æœè¿™ä¸ªæ ‡å¿—ä½ä¸º0ï¼Œåˆ™åªæœ‰supervisor modeå¯ä»¥ä½¿ç”¨è¿™ä¸ªé¡µè¡¨)

> supervisor modeä¸­çš„ä»£ç å¹¶ä¸èƒ½è¯»å†™ä»»æ„ç‰©ç†åœ°å€ã€‚**åœ¨supervisor modeä¸­**ï¼Œå°±åƒæ™®é€šçš„ç”¨æˆ·ä»£ç ä¸€æ ·ï¼Œ**ä¹Ÿéœ€è¦é€šè¿‡page tableæ¥è®¿é—®å†…å­˜ã€‚**
å¦‚æœä¸€ä¸ªè™šæ‹Ÿåœ°å€å¹¶ä¸åœ¨å½“å‰ç”±SATPæŒ‡å‘çš„page tableä¸­ï¼Œåˆæˆ–è€…SATPæŒ‡å‘çš„page tableä¸­PTE_U=1ï¼Œé‚£ä¹ˆsupervisor modeä¸èƒ½ä½¿ç”¨é‚£ä¸ªåœ°å€ã€‚
æ‰€ä»¥ï¼Œå³ä½¿æˆ‘ä»¬åœ¨supervisor modeï¼Œæˆ‘ä»¬è¿˜æ˜¯å—é™äºå½“å‰page tableè®¾ç½®çš„è™šæ‹Ÿåœ°å€ã€‚
> 

**gdbè·Ÿè¸ªwriteç³»ç»Ÿè°ƒç”¨**

**ecallè°ƒç”¨å‰(è¿˜åœ¨ç”¨æˆ·æ€)**

```cpp
# write syscall implementation -- usys.S

write:
	
	li a7, SYS_write # å°†ç³»ç»Ÿè°ƒç”¨å·SYS_writeåŠ è½½åˆ°å¯„å­˜å™¨a7ä¸­
	
	ecall # è½¬å…¥å†…æ ¸ç©ºé—´
	
	ret # ä»å†…æ ¸ç©ºé—´è¿”å›è‡³ç”¨æˆ·ç©ºé—´æ‰§è¡Œç”¨æˆ·ç©ºé—´åç»­ä»£ç 
```

[](https://www.bilibili.com/video/BV19k4y1C7kA?p=5)

> GDB
> 

> print $pc -- æ‰“å°PCæŒ‡é’ˆçš„å€¼
> 

> info reg -- å°†32ä¸ªå¯„å­˜å™¨å…¨éƒ¨æ‰“å°å‡ºæ¥
> 

![Trap%204591d26b99d04fb9b9e858b19bcd61ee/image5.png](Trap%204591d26b99d04fb9b9e858b19bcd61ee/image5.png)

å¯ä»¥çœ‹åˆ°pcæŒ‡é’ˆå’Œstack pointeréƒ½åœ¨ä½åœ°å€ï¼Œåœ°å€éå¸¸æ¥è¿‘äº0ï¼Œè¿™è¿›ä¸€æ­¥å°è¯äº†**å½“å‰ä»£ç è¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´**ï¼Œå› ä¸º**ç”¨æˆ·ç©ºé—´ä¸­æ‰€æœ‰çš„åœ°å€éƒ½æ¯”è¾ƒå°**ã€‚ä½†æ˜¯ä¸€æ—¦æˆ‘ä»¬è¿›å…¥åˆ°äº†å†…æ ¸ç©ºé—´(trampoline)ï¼Œå†…æ ¸ä¼šä½¿ç”¨å¤§å¾—å¤šçš„å†…å­˜åœ°å€ã€‚

**è¿™äº›ä¸ªåœ°å€å€¼æ˜¯ ç”¨æˆ·ç¨‹åºçš„è™šæ‹Ÿåœ°å€**

**ecallè°ƒç”¨å**

ç°åœ¨æˆ‘æ‰§è¡ŒecallæŒ‡ä»¤ï¼Œ

![Trap%204591d26b99d04fb9b9e858b19bcd61ee/image6.png](Trap%204591d26b99d04fb9b9e858b19bcd61ee/image6.png)

ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œæ‰§è¡Œå®Œäº†ecallä¹‹åæˆ‘ä»¬ç°åœ¨åœ¨å“ªï¼Ÿæˆ‘ä»¬å¯ä»¥æ‰“å°ç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counterï¼‰æ¥æŸ¥çœ‹ã€‚

![Trap%204591d26b99d04fb9b9e858b19bcd61ee/image7.png](Trap%204591d26b99d04fb9b9e858b19bcd61ee/image7.png)

å¯ä»¥çœ‹åˆ°ç¨‹åºè®¡æ•°å™¨çš„å€¼å˜åŒ–äº†ï¼Œä¹‹å‰æˆ‘ä»¬çš„ç¨‹åºè®¡æ•°å™¨è¿˜åœ¨ä¸€ä¸ªå¾ˆå°çš„åœ°å€0xde6ï¼Œä½†æ˜¯ç°åœ¨åœ¨ä¸€ä¸ªå¤§å¾—å¤šçš„åœ°å€ã€‚ï¼ˆPCå€¼ä¸ºtrampolineï¼‰

![Trap%204591d26b99d04fb9b9e858b19bcd61ee/image8.png](Trap%204591d26b99d04fb9b9e858b19bcd61ee/image8.png)

æˆ‘ä»¬è¿˜å¯ä»¥æŸ¥çœ‹page tableï¼Œæˆ‘é€šè¿‡åœ¨QEMUä¸­æ‰§è¡Œinfo memæ¥æŸ¥çœ‹å½“å‰çš„page tableï¼Œå¯ä»¥çœ‹å‡ºï¼Œè¿™è¿˜æ˜¯ä¸ä¹‹å‰å®Œå…¨ç›¸åŒçš„page tableï¼Œæ‰€ä»¥**page tableæ²¡æœ‰æ”¹å˜**ã€‚

![Trap%204591d26b99d04fb9b9e858b19bcd61ee/image9.png](Trap%204591d26b99d04fb9b9e858b19bcd61ee/image9.png)

æ ¹æ®ç°åœ¨çš„ç¨‹åºè®¡æ•°å™¨ï¼Œä»£ç æ­£åœ¨**ç”¨æˆ·é¡µè¡¨çš„trampoline page**çš„æœ€å¼€å§‹ï¼Œè¿™æ˜¯ç”¨æˆ·å†…å­˜ä¸­ä¸€ä¸ªéå¸¸å¤§çš„åœ°å€ã€‚æ‰€ä»¥ç°åœ¨æˆ‘ä»¬çš„æŒ‡ä»¤æ­£è¿è¡Œåœ¨å†…å­˜çš„trampoline pageä¸­ã€‚æˆ‘ä»¬å¯ä»¥æ¥æŸ¥çœ‹ä¸€ä¸‹ç°åœ¨å°†è¦è¿è¡Œçš„æŒ‡ä»¤ã€‚

## **Real World**

å®é™…ä¸Šï¼Œæœ‰çš„æœºå™¨åœ¨æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œä¼šåœ¨ç¡¬ä»¶ä¸­å®Œæˆæ‰€æœ‰ä¸‹é¢è¿™äº›å·¥ä½œã€‚ä½†æ˜¯RISC-Vå¹¶ä¸ä¼šï¼ŒRISC-Vç§‰æŒäº†è¿™æ ·ä¸€ä¸ªè§‚ç‚¹ï¼šecallåªå®Œæˆå°½é‡å°‘å¿…é¡»è¦å®Œæˆçš„å·¥ä½œï¼Œå…¶ä»–çš„å·¥ä½œéƒ½äº¤ç»™è½¯ä»¶å®Œæˆã€‚è¿™é‡Œçš„åŸå› æ˜¯ï¼ŒRISC-Vè®¾è®¡è€…æƒ³è¦ä¸ºè½¯ä»¶å’Œæ“ä½œç³»ç»Ÿçš„ç¨‹åºå‘˜æä¾›æœ€å¤§çš„çµæ´»æ€§ï¼Œè¿™æ ·ä»–ä»¬å°±èƒ½æŒ‰ç…§ä»–ä»¬æƒ³è¦çš„æ–¹å¼å¼€å‘æ“ä½œç³»ç»Ÿã€‚æ‰€ä»¥ä½ å¯ä»¥è¿™æ ·æƒ³ï¼Œå°½ç®¡XV6å¹¶æ²¡æœ‰ä½¿ç”¨è¿™é‡Œæä¾›çš„çµæ´»æ€§ï¼Œä½†æ˜¯ä¸€äº›å…¶ä»–çš„æ“ä½œç³»ç»Ÿç”¨åˆ°äº†ã€‚

- ä¸¾ä¸ªä¾‹å­ï¼Œå› ä¸ºè¿™é‡Œçš„ecallæ˜¯å¦‚æ­¤çš„ç®€å•ï¼Œæˆ–è®¸æŸäº›æ“ä½œç³»ç»Ÿå¯ä»¥åœ¨**ä¸åˆ‡æ¢page table**çš„å‰æä¸‹ï¼Œæ‰§è¡Œéƒ¨åˆ†ç³»ç»Ÿè°ƒç”¨ï¼ˆåœ¨Xv6ä¸­é‚£å°±æ˜¯åœ¨trampoline.Sä¸­ä¸è¦restore kernel page tableï¼‰ã€‚åˆ‡æ¢page tableçš„ä»£ä»·æ¯”è¾ƒé«˜ï¼Œå¦‚æœecallæ‰“åŒ…å®Œæˆäº†è¿™éƒ¨åˆ†å·¥ä½œï¼Œé‚£å°±ä¸èƒ½å¯¹ä¸€äº›ç³»ç»Ÿè°ƒç”¨è¿›è¡Œæ”¹è¿›ï¼Œä½¿å…¶ä¸ç”¨åœ¨ä¸å¿…è¦çš„åœºæ™¯åˆ‡æ¢page tableã€‚
- æŸäº›æ“ä½œç³»ç»ŸåŒæ—¶å°†userå’Œkernelçš„è™šæ‹Ÿåœ°å€æ˜ å°„åˆ°ä¸€ä¸ªpage tableä¸­ï¼Œè¿™æ ·åœ¨userå’Œkernelä¹‹é—´åˆ‡æ¢æ—¶æ ¹æœ¬å°±ä¸ç”¨åˆ‡æ¢page tableã€‚å¯¹äºè¿™æ ·çš„æ“ä½œç³»ç»Ÿæ¥è¯´ï¼Œå¦‚æœecallåˆ‡æ¢äº†page tableé‚£å°†ä¼šæ˜¯ä¸€ç§æµªè´¹ï¼Œå¹¶ä¸”ä¹Ÿå‡æ…¢äº†ç¨‹åºçš„è¿è¡Œã€‚
- æˆ–è®¸åœ¨ä¸€äº›ç³»ç»Ÿè°ƒç”¨è¿‡ç¨‹ä¸­ï¼Œä¸€äº›å¯„å­˜å™¨ä¸ç”¨ä¿å­˜ï¼Œè€Œå“ªäº›å¯„å­˜å™¨éœ€è¦ä¿å­˜ï¼Œå“ªäº›ä¸éœ€è¦ï¼Œå–å†³äºäºè½¯ä»¶ï¼Œç¼–ç¨‹è¯­è¨€ï¼Œå’Œç¼–è¯‘å™¨ã€‚é€šè¿‡ä¸ä¿å­˜æ‰€æœ‰çš„32ä¸ªå¯„å­˜å™¨æˆ–è®¸å¯ä»¥èŠ‚çœå¤§é‡çš„ç¨‹åºè¿è¡Œæ—¶é—´ï¼Œæ‰€ä»¥ä½ ä¸ä¼šæƒ³è¦ecallè¿«ä½¿ä½ ä¿å­˜æ‰€æœ‰çš„å¯„å­˜å™¨ã€‚
- æœ€åï¼Œå¯¹äºæŸäº›ç®€å•çš„ç³»ç»Ÿè°ƒç”¨æˆ–è®¸æ ¹æœ¬å°±ä¸éœ€è¦ä»»ä½•stackï¼Œæ‰€ä»¥å¯¹äºä¸€äº›éå¸¸å…³æ³¨æ€§èƒ½çš„æ“ä½œç³»ç»Ÿï¼Œecallä¸ä¼šè‡ªåŠ¨ä¸ºä½ å®Œæˆstackåˆ‡æ¢æ˜¯æå¥½çš„ã€‚

æ‰€ä»¥ï¼Œecallå°½é‡çš„ç®€å•å¯ä»¥æå‡è½¯ä»¶è®¾è®¡çš„çµæ´»æ€§ã€‚

# **å¼€å§‹æ‰§è¡Œtrampoline page**

## **ä»uservecå‡½æ•°å¼€å§‹ -- ä¿å­˜ç”¨æˆ·å¯„å­˜å™¨ã€è®¾ç½®å†…æ ¸æ ˆã€åˆ‡æ¢é¡µè¡¨ã€è·³è½¬æ‰§è¡Œusertrap() from trampoline.S**

> æ”¹satpå¯„å­˜å™¨ç”¨kernel pagetableæ˜ å°„å­˜å‚¨ç”¨æˆ·å¯„å­˜å™¨ï¼Ÿ
> 

> ä¸è¡Œï¼Œtrapæœºåˆ¶çš„æœ€å¼€å§‹ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“kernel page tableçš„åœ°å€ã€‚å¹¶ä¸”æ›´æ”¹SATPå¯„å­˜å™¨çš„æŒ‡ä»¤ï¼Œè¦æ±‚å†™å…¥SATPå¯„å­˜å™¨çš„å†…å®¹æ¥è‡ªäºå¦ä¸€ä¸ªå¯„å­˜å™¨ã€‚
> 

æ¯ä¸ªè¿›ç¨‹åœ¨ç”¨æˆ·è™šæ‹Ÿå†…å­˜ä¸­Allocateä¸€éƒ¨åˆ†ç©ºé—´ï¼Œå«åštrapframeï¼Œè¿™ä¸ªä½ç½®çš„è™šæ‹Ÿåœ°å€æ€»æ˜¯0x3ffffffe000ï¼Œåç»­ç»è¿‡ä¸€ç•ªæ“ä½œç”¨æ¥ä¿å­˜ç”¨æˆ·å¯„å­˜å™¨

trapframeä¸­å°†å­˜å‚¨æŸä¸ªè¿›ç¨‹è‡ªèº«çš„è¿™äº›æ•°æ®ï¼Œåœ¨proc.hä¸­å¯æŸ¥çœ‹

![Trap%204591d26b99d04fb9b9e858b19bcd61ee/image10.png](Trap%204591d26b99d04fb9b9e858b19bcd61ee/image10.png)

Trapåˆšåˆšå¼€å§‹ï¼Œä½äºtrampolineå¼€å§‹ï¼Œæ‰§è¡Œuservecæ±‡ç¼–å‡½æ•°ï¼Œç¬¬ä¸€æ¡æŒ‡ä»¤æ˜¯ï¼š

![Trap%204591d26b99d04fb9b9e858b19bcd61ee/image11.png](Trap%204591d26b99d04fb9b9e858b19bcd61ee/image11.png)

sscratchå¯„å­˜å™¨å­˜å‚¨ç€trapframeåœ°å€ï¼Œè¿™ä¸ªæŒ‡ä»¤å°†a0ä¸**sscratch**å¯„å­˜å™¨å†…å®¹äº¤æ¢ï¼Œa0å­˜å‚¨ç€trapframeåœ°å€ï¼Œsscratchå­˜å‚¨ç€å…ˆå‰a0ä¸­çš„Shellä¼ å…¥çš„æ–‡ä»¶æè¿°ç¬¦2

[å¯¹äºè¿™ä¸€æ­¥æœ‰ç–‘æƒ‘ï¼Ÿ](https://mit-public-courses-cn-translatio.gitbook.io/mit6-s081/lec06-isolation-and-system-call-entry-exit-robert/6.5-uservec#:~:text=%E5%AD%A6%E7%94%9F%E6%8F%90%E9%97%AE%EF%BC%9A%E5%BD%93%E4%B8%8Ea0%E5%AF%84%E5%AD%98%E5%99%A8%E8%BF%9B%E8%A1%8C%E4%BA%A4%E6%8D%A2%E6%97%B6%EF%BC%8Ctrapframe%E7%9A%84%E5%9C%B0%E5%9D%80%E6%98%AF%E6%80%8E%E4%B9%88%E5%87%BA%E7%8E%B0%E5%9C%A8SSCRATCH%E5%AF%84%E5%AD%98%E5%99%A8%E4%B8%AD%E7%9A%84%EF%BC%9F)

![Trap%204591d26b99d04fb9b9e858b19bcd61ee/image12.png](Trap%204591d26b99d04fb9b9e858b19bcd61ee/image12.png)

æ¥ä¸‹æ¥çš„æŒ‡ä»¤å°†æ¯ä¸ªå¯„å­˜å™¨ä¿å­˜åœ¨trapframeçš„ä¸åŒåç§»ä½ç½®ã€‚å› ä¸ºa0åœ¨äº¤æ¢å®Œä¹‹ååŒ…å«çš„æ˜¯trapframe pageåœ°å€ï¼Œä¹Ÿå°±æ˜¯0x3fffffe000ã€‚æ‰€ä»¥ï¼Œæ¯ä¸ªå¯„å­˜å™¨è¢«ä¿å­˜åœ¨äº†åç§»é‡+a0çš„ä½ç½®ã€‚

![Trap%204591d26b99d04fb9b9e858b19bcd61ee/image13.png](Trap%204591d26b99d04fb9b9e858b19bcd61ee/image13.png)

ld sp 8(a0)å°† a0æŒ‡å‘çš„å†…å­˜åœ°å€ å¾€åæ•°çš„ç¬¬8ä¸ªå­—èŠ‚å¼€å§‹çš„æ•°æ®åŠ è½½åˆ° Stack Pointerå¯„å­˜å™¨

ld tp, 32(a0) xv6å°†CPUæ ¸çš„ç¼–å·ä¹Ÿå°±æ˜¯hartidä¿å­˜åœ¨tpå¯„å­˜å™¨

ld t0, 16(a0)å°†Cå‡½æ•°usertrap()åœ°å€åŠ è½½åˆ°t0å¯„å­˜å™¨ä¸­ï¼Œåç»­ä¼šç”¨åˆ°

ld t1, 0(a0)å°†å…¨å±€å†…æ ¸é¡µè¡¨åœ°å€åŠ è½½åˆ°t1ä¸­ï¼Œç¨åå†™åˆ°satpä¸­(satpå€¼åªèƒ½æ¥è‡ªå¦ä¸€ä¸ªå¯„å­˜å™¨<sup>âˆš</sup>)

csrw satp, t1è®¾ç½®satpï¼Œä»user page tableåˆ‡æ¢åˆ°kernel page tableï¼Œä»è¿™é‡Œå¼€å§‹æˆ‘ä»¬å°±å¯ä»¥æ‰§è¡Œå†…æ ¸Cä»£ç äº†

> ä½†æˆ‘ä»¬è¿˜åœ¨trampolineä»£ç ä¸­ï¼Œè€Œtrampolineä»£ç åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´éƒ½æ˜ å°„åˆ°äº†åŒä¸€ä¸ªåœ°å€ï¼Œå› æ­¤ç¨‹åºä¸ä¼šå´©æºƒ
> 

jr t0ä»trampolineè·³åˆ°å†…æ ¸çš„Cä»£ç æ‰§è¡Œï¼Œt0çš„ä½ç½®å¯¹åº”äºä¸€ä¸ªå«åšusertrapå‡½æ•°çš„å¼€å§‹ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦ä»¥kernel stackï¼Œkernel page tableè·³è½¬åˆ°usertrapå‡½æ•°ã€‚

## **usertrap -- ç¡®å®štrapçš„åŸå› ï¼Œå¯¹åº”åŸå› å¤„ç†å®ƒï¼Œè¿”å›**

æœ‰å¾ˆå¤šåŸå› éƒ½å¯ä»¥è®©ç¨‹åºè¿è¡Œè¿›å…¥åˆ°usertrapå‡½æ•°ä¸­æ¥ï¼Œæ¯”å¦‚[ç³»ç»Ÿè°ƒç”¨]ï¼Œ[è¿ç®—æ—¶é™¤ä»¥0ï¼Œä½¿ç”¨äº†ä¸€ä¸ªæœªè¢«æ˜ å°„çš„è™šæ‹Ÿåœ°å€]ï¼Œæˆ–è€…æ˜¯[è®¾å¤‡ä¸­æ–­]ã€‚

å…ˆè®¾ç½®stvecæˆkernelvecï¼Œè™½ç„¶ä½äºå†…æ ¸æ€ï¼Œä½†xv6æ”¯æŒå†…æ ¸trapï¼Œå½“trapæ¥ä¸´ï¼Œå¤„ç†trapçš„æ˜¯kernelvec(kernelvec.S)ï¼Œåœ¨ä»ç”¨æˆ·æ€è¿›å…¥å†…æ ¸æ€æ—¶ï¼ŒRISC-Vä¼šè‡ªåŠ¨å…ˆå…³é—­ä¸­æ–­ï¼Œç›´åˆ°è¿™é‡Œè®¾ç½®å¥½åœ¨å†…æ ¸å¦‚ä½•å¤„ç†trapåï¼Œåœ¨è¯†åˆ«å®Œé‚£ç§trapç±»å‹åä¼šåœ¨syscallç±»å‹ä¸­syscallæ‰§è¡Œå‰æ‰“å¼€ä¸­æ–­

![Trap%204591d26b99d04fb9b9e858b19bcd61ee/image14.png](Trap%204591d26b99d04fb9b9e858b19bcd61ee/image14.png)

![Trap%204591d26b99d04fb9b9e858b19bcd61ee/image15.png](Trap%204591d26b99d04fb9b9e858b19bcd61ee/image15.png)

r_scauseä»scauseå¯„å­˜å™¨ä¸­çœ‹trapåŸå› 

## **usertrapret() -- ä¸ºä¸‹æ¬¡trapå‡†å¤‡è®¾ç½®å¯„å­˜å™¨**

![Trap%204591d26b99d04fb9b9e858b19bcd61ee/image16.png](Trap%204591d26b99d04fb9b9e858b19bcd61ee/image16.png)

## **userret -- æ¢å¤ç”¨æˆ·å¯„å­˜å™¨**

![Trap%204591d26b99d04fb9b9e858b19bcd61ee/image17.png](Trap%204591d26b99d04fb9b9e858b19bcd61ee/image17.png)

![Trap%204591d26b99d04fb9b9e858b19bcd61ee/image18.png](Trap%204591d26b99d04fb9b9e858b19bcd61ee/image18.png)

# **å¦‚ä½•å®ç°ä»ç”¨æˆ·ä¸­æ–­ç‚¹è¿›å…¥å†…æ ¸å†å‡ºæ¥æ¢å¤ç”¨æˆ·ä»£ç æ‰§è¡Œï¼Ÿ(PC)**

ä»¥Syscallä¸ºä¾‹å­ï¼š

1. ç”¨æˆ·ä»£ç è°ƒç”¨ecallåï¼ŒRISC-Vç¡¬ä»¶ä¿å­˜ç”¨æˆ·PCåˆ°å¯„å­˜å™¨sepc
2. åœ¨è¿›å…¥usertrap()å¤„ç†trapæ—¶æœ‰ä¸€æ®µè¿™æ ·çš„ä»£ç ï¼š

![Trap%204591d26b99d04fb9b9e858b19bcd61ee/image19.png](Trap%204591d26b99d04fb9b9e858b19bcd61ee/image19.png)

r_sepc()è¯»å–sepcå¯„å­˜å™¨ï¼Œè¿™ä¸ªå¯„å­˜å™¨å€¼ä¸ºç¡¬ä»¶è¡Œä¸ºä¸­å†™å…¥çš„ç”¨æˆ·PCå€¼

å› æ­¤åˆ°è¿™é‡Œç”¨æˆ·PCè¢«ä¿å­˜åˆ°äº†p->trapframe->epcä¸­ï¼Œsepcå¯„å­˜å™¨å¯èƒ½ä¼šè¢«è¦†ç›–(kernel trapä¸­kernelvecå¯ä»¥è¦†ç›–sepcå¯„å­˜å™¨)

1. å½“å¤„ç†å®Œtrapåæ‰§è¡Œusertrapretï¼Œå†æ¢å¤ï¼Œå°†ç”¨æˆ·PCå†™å…¥åˆ°sepc

![Trap%204591d26b99d04fb9b9e858b19bcd61ee/image20.png](Trap%204591d26b99d04fb9b9e858b19bcd61ee/image20.png)

1. userretæœ€ç»ˆçš„sreté™¤äº†åˆ‡æ¢modeå¤–ï¼Œè¿˜ä¼šå°†PCåˆ‡æ¢æˆsepcï¼Œsepcåœ¨ä¸Šä¸€æ­¥è¢«è®¾ç½®æˆç”¨æˆ·ä¹‹å‰çš„PCï¼Œå› æ­¤è¿™é‡Œå¯ä»¥æ¢å¤ç”¨æˆ·ä»£ç æ‰§è¡Œ

![Trap%204591d26b99d04fb9b9e858b19bcd61ee/image21.png](Trap%204591d26b99d04fb9b9e858b19bcd61ee/image21.png)

# **æ— æ³•ä¿¡ä»» -- ä½¿ç”¨è½¯ä»¶æ¨¡æ‹ŸMMUæŸ¥è¡¨**

æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ—¶å¯èƒ½ä¼šæœ‰ä¼ å‚ï¼Œæˆ‘ä»¬æŠŠè¿™äº›å‚æ•°æ”¾åœ¨å‚æ•°å¯„å­˜å™¨é‡Œï¼Œå½“å†…æ ¸éœ€è¦æ—¶é€šè¿‡å†…æ ¸æ€argrawå‡½æ•°è¯»å–è¿›ç¨‹trapframè¯»å–å‡ºæ¥ï¼Œä½†æ˜¯è¿™äº›å‚æ•°å¯èƒ½æ˜¯æŒ‡å‘ç”¨æˆ·ç©ºé—´è™šæ‹Ÿå†…å­˜åœ°å€çš„æŒ‡é’ˆï¼Œå†…æ ¸éœ€è¦ä»è¿™ä¸ªç”¨æˆ·æ€å†…å­˜è¯»å–æˆ–å†™å…¥ã€‚

ä½†è¿™äº›**ç”¨æˆ·æŒ‡é’ˆå¯èƒ½å­˜åœ¨ä¸€å®šé£é™©**ï¼š

é¦–å…ˆï¼Œç”¨æˆ·ç¨‹åºå¯èƒ½æ˜¯é”™è¯¯çš„æˆ–æ¶æ„çš„ï¼Œå¯èƒ½ä¼šä¼ é€’ç»™å†…æ ¸ä¸€ä¸ªæ— æ•ˆçš„æŒ‡é’ˆæˆ–ä¸€ä¸ªæ—¨åœ¨**æ¬ºéª—å†…æ ¸è®¿é—®å†…æ ¸å†…å­˜ è€Œ ä¸æ˜¯ ç”¨æˆ·å†…å­˜çš„æŒ‡é’ˆ**ã€‚

ç¬¬äºŒï¼Œxv6å†…æ ¸é¡µè¡¨æ˜ å°„ä¸ç”¨æˆ·é¡µè¡¨æ˜ å°„ä¸ä¸€æ ·ï¼Œæ‰€ä»¥å†…æ ¸ä¸èƒ½ä½¿ç”¨æ™®é€šæŒ‡ä»¤ä»ç”¨æˆ·æä¾›çš„åœ°å€åŠ è½½æˆ–å­˜å‚¨ã€‚

å†…æ ¸å®ç°äº†å®‰å…¨åœ°å°†æ•°æ®å¤åˆ¶åˆ°ç”¨æˆ·æä¾›çš„åœ°å€æˆ–ä»ç”¨æˆ·æä¾›çš„åœ°å€å¤åˆ¶æ•°æ®çš„å‡½æ•°ã€‚ä¾‹å¦‚**fetchstr(kernel/syscall.c:25)**

**fetchstrè°ƒç”¨copyinstrï¼Œcopyinstræ¨¡æ‹ŸMMUï¼Œå¯¹ç”¨æˆ·è™šæ‹Ÿåœ°å€ç¿»è¯‘æˆç‰©ç†åœ°å€**

# **æ¥è‡ªå†…æ ¸æ€çš„Trap**

ç”±äºé¡µè¡¨ä¸ºå†…æ ¸é¡µè¡¨ï¼Œæ ˆæŒ‡é’ˆæŒ‡å‘å†…æ ¸æ ˆï¼Œå› æ­¤è¿™äº›ä¸åŠ¨ï¼Œä¸€æ—¦ç”¨æˆ·æ€è¿›ç¨‹å‘ç”Ÿä¸­æ–­æ—¶ï¼Œç”±äºåœ¨usertrap()ä¸­è®¾ç½®äº†stvecä¸ºkernelvecï¼Œæ­¤æ—¶æˆ‘ä»¬è·³è½¬åˆ°kernelvec (kernelvec.S)æ‰§è¡Œï¼š

- kernelvecå…ˆä¿å­˜å…ˆå‰å†…æ ¸è¿›ç¨‹å¯„å­˜å™¨(kernelvec saves the registers on the stack of the interrupted kernel thread)ï¼Œç”±äºå¯èƒ½å­˜åœ¨è¿›ç¨‹åˆ‡æ¢( in that case the trap will actually return on the stack of the new thread, leaving the `interrupted thread`â€™s saved registers safely on its stack.) -- æ³¨æ„ï¼škernel trapä¿å­˜å¯„å­˜å™¨æ—¶æ˜¯å°†å…¶ä¿å­˜åˆ°ç”¨æˆ·è¿›ç¨‹çš„å†…æ ¸æ ˆä¸Šï¼Œç­‰kerneltrap()æ‰§è¡Œå®Œå†ä»æ ˆä¸Šæ¢å¤ï¼ˆkernelvec.Sï¼‰
- kernelvecåœ¨ä¿å­˜å¥½è¢«æ‰“æ–­å†…æ ¸è¿›ç¨‹å¯„å­˜å™¨åï¼Œæ‰§è¡Œtrap.cä¸­çš„kerneltap()ï¼Œkerneltrapç”¨æ¥è¯†åˆ«å†…æ ¸trapç±»å‹ï¼Œå¯èƒ½æ˜¯ä¸­æ–­/å¼‚å¸¸ï¼Œå¯¹åº”å¤„ç†
- å¤„ç†å®Œkernel trapåæ¢å¤åŸè¿›ç¨‹çš„å¯„å­˜å™¨ï¼Œ**å°†sepcå¤åˆ¶åˆ°pcä¸­æ¢å¤interrupted kernel code**

> æ³¨æ„ï¼šä»ç”¨æˆ·æ€åˆ°å†…æ ¸æ€å¤„ç†trapä¸­ï¼Œæœ‰ä¸€æ®µæ—¶é—´stvecè¿˜ä¸æ˜¯kernelvecï¼Œå› æ­¤è¿™æ®µæ—¶é—´çš„å†…æ ¸æ€æ˜¯ä¸èƒ½å‘ç”Ÿä¸­æ–­çš„ï¼Œå¹¸è¿çš„æ˜¯RISC-Væ€»æ˜¯åœ¨å¼€å§‹trapæ—¶å…³é—­ä¸­æ–­ï¼Œç›´åˆ°æˆ‘ä»¬åœ¨usertrapä¸­è®¾ç½®å¥½stvecåæ‰æ‰“å¼€ä¸­æ–­(`intr_on()`)
> 

![Untitled](Trap%204591d26b99d04fb9b9e858b19bcd61ee/Untitled%203.png)

![Untitled](Trap%204591d26b99d04fb9b9e858b19bcd61ee/Untitled%204.png)

![Untitled](Trap%204591d26b99d04fb9b9e858b19bcd61ee/Untitled%205.png)

![Untitled](Trap%204591d26b99d04fb9b9e858b19bcd61ee/Untitled%206.png)