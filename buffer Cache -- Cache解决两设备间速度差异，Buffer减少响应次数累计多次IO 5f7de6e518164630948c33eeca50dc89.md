# buffer? Cache? -- Cache解决两设备间速度差异，Buffer减少响应次数累计多次IO成一次

板块: IO与文件系统

# Cache 和 Buffer 都是缓存，主要区别是什么？

1. **Cache**（缓存）：-- 平衡高低速设备间的速度差异 利用 局部性原理 将热数据从低速设备迁移到高速设备缓存 弥补高速设备和低速设备的鸿沟而引入的中间层，最终起到**加快访问速度**的作用。
a. CPU与内存间的多级高速缓存，利用时、空局部性原理将hot data、hot instruction(刚刚访问的、附近的数据)放入这多级CPU缓存 -- 解决CPU与内存间速度差距
    
    b. 在磁盘和CPU之间也插入Cache，这个Cache分为：
    
    内核在内存中分配的Block Cache数据结构读写先到内存这里来 
    
    硬盘自身硬件自带的
    
    -- 解决硬盘与内存间速度差异
    
    ![Untitled](buffer%20Cache%20--%20Cache%E8%A7%A3%E5%86%B3%E4%B8%A4%E8%AE%BE%E5%A4%87%E9%97%B4%E9%80%9F%E5%BA%A6%E5%B7%AE%E5%BC%82%EF%BC%8CBuffer%E5%87%8F%E5%B0%91%E5%93%8D%E5%BA%94%E6%AC%A1%E6%95%B0%E7%B4%AF%E8%AE%A1%E5%A4%9A%E6%AC%A1IO%205f7de6e518164630948c33eeca50dc89/Untitled.png)
    
    这两种Cache都通过一定的规则（CPU的多级高速缓存通过MESI协议、内存中Block Cache可以通过进程对同一块Block的内核数据结构重复改写而不是直接读写硬盘并通过日志事务），在保证数据一致性的前提下，后续等到一定时机再将数据写入慢速设备
    
2. **Buffer**（缓冲区 其实也有缓存数据的作用） -- 合并大量I/O为单次，进行流量整形，把突发的大数量较小规模的 I/O 整理成平稳的小数量较大规模的 I/O，以**减少响应次数 实现异步并发**
    
    <aside>
    💡 I/O本身一次会有很大的时延，如果说短时间内有大量的I/O请求，每次I/O时间都会很长，那么我们引入Buffer将多次I/O操作合并到一块成大数据I/O，再一次性I/O硬盘
    
    </aside>
    
        比如说吐鲁番的葡萄熟了，要用大卡车装葡萄运出去卖。但问题是，卡车距离葡萄园很远，于是就需要在葡萄园和卡车之间往返多次才能把卡车装满。往返所需要的时间就是I/O延迟，比如往返各15分钟，总共半小时。果园的姑娘采摘葡萄，难道是摘一串葡萄，就花15分钟跑到卡车旁边放进去么？如果是这样，100串葡萄就需要往返200次，所需要的时间就是100X15X2分钟，那是何其漫长!所以聪明的做法就是暂时把100串葡萄放入一个箩筐，再以箩筐为单位倒入卡车，一箩筐（100串）葡萄的往返延迟是半小时。由此可见，“箩筐”把输入参数暂时集中放在一起，不是“一条一条”，而是“一股脑”地提供给下家处理。这就大大降低了I/O的次数，也就降低了I/O延迟，提高了速度。这个箩筐，就是Buffer。
    
        以BT为例，BT下载需要长时间的挂机，电脑就有可能24小时连轴转，但BT下载的数据是碎片化的，体现在硬盘写入上也是碎片化的，因为硬盘是机械寻址器件，寻址/写入的过程会带来机械运动，长时间的小碎片写入会造成硬盘长时间高负荷的机械运动，造成硬盘过早老化损坏，当年有大量的硬盘因为BT下载而损坏。于是新出的BT软件在内存里开辟了Buffer，数据暂时写入Buffer，攒到一定的大小（比如512M）再一次性写入硬盘，这种“化零为整”的写入方式因为大大减小了寻址/写入次数，所以就降低了硬盘的负荷。这就是：为了完成最终目标：把数据写入硬盘空间，需要暂时写入Buffer的空间。
    
        再以编程为例，假设要实现一个功能：接受用户键入的字符串，并赋值给一个字符串变量其过程如下：
    1：在内存中开辟一个”键盘缓冲区“接受用户键入的字符串
    2：把缓冲区中的字符串copy到程序中定义的字符串变量指向的内存空间（也就是赋值过程）也就是说，为了完成最终目标：把字符串放入字符串变量指向的空间，需要暂时把字符串放入“键盘缓冲区”的空间。
    
        比如生产者——消费者问题，他们产生和消耗资源的速度大体接近，加一个buffer可以抵消掉资源刚产生/消耗时的突然变化
    

![Untitled](buffer%20Cache%20--%20Cache%E8%A7%A3%E5%86%B3%E4%B8%A4%E8%AE%BE%E5%A4%87%E9%97%B4%E9%80%9F%E5%BA%A6%E5%B7%AE%E5%BC%82%EF%BC%8CBuffer%E5%87%8F%E5%B0%91%E5%93%8D%E5%BA%94%E6%AC%A1%E6%95%B0%E7%B4%AF%E8%AE%A1%E5%A4%9A%E6%AC%A1IO%205f7de6e518164630948c33eeca50dc89/Untitled%201.png)

## 参考

[1.] [https://www.zhihu.com/question/26190832/answer/140368830](https://www.zhihu.com/question/26190832/answer/140368830)