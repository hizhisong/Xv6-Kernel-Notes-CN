# Xv6 æ–‡ä»¶ç³»ç»Ÿ -- ç¼“å­˜å’ŒåŒæ­¥è®¿é—®ç£ç›˜

æ¿å—: IOä¸æ–‡ä»¶ç³»ç»Ÿ

# Xv6çš„IOæ˜¯ä¸€ç§åŒæ­¥é˜»å¡å¼IOï¼Œåˆ©ç”¨è¿™ä¸ªå’Œoutstandingè®¡æ•°(åœ¨åŒä¸€commitå†…FS syscall/äº‹åŠ¡æ•°)ä¿è¯ FS syscall åŸå­æ€§

# Xv6çš„ä¸ƒå±‚æ–‡ä»¶ç³»ç»Ÿ

![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled.png)

# 1. Xv6 æ–‡ä»¶ç³»ç»Ÿå¸ƒå±€

<aside>
ğŸ’¡ P.S. æ–‡ä»¶ç³»ç»Ÿçš„åˆ¶ä½œæ˜¯ç”±mkfs/mkfs.cåˆ¶ä½œ

</aside>

æ–‡ä»¶ç³»ç»Ÿçœ¼ä¸­çš„ç£ç›˜æ˜¯ä¸€ä¸ª å·¨å‹æ•°ç»„ï¼Œ å°†æ•°æ®ç»“æ„æ”¾ç½®åœ¨æ•°ç»„ä¸­ï¼Œé‡å¯ååˆèƒ½æ ¹æ®ä»è¿™äº›æ•°æ®ç»“æ„æ¢å¤æ–‡ä»¶ç³»ç»Ÿ

![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%201.png)

æ–‡ä»¶ç³»ç»Ÿä»¥å—(block)åˆ†é…ç¡¬ç›˜å­˜å‚¨ç©ºé—´ï¼Œä¸€ä¸ªå—åœ¨XV6ä¸­ä¸º1024bytesï¼Œå…¶å°†ç¡¬ç›˜å­˜å‚¨ç©ºé—´ç¼–å¥½å—å·(block number)ï¼Œå¹¶ä»¥æ­¤å¯»å€

## boot

å¼•å¯¼æ“ä½œç³»ç»Ÿå¯åŠ¨

## super

æè¿°æ–‡ä»¶ç³»ç»Ÿ æ–‡ä»¶ç³»ç»Ÿè‡ªèº«çš„åŸºæœ¬æ•°æ®(file system meta-data)ï¼›ä»¥å—ä¸ºå•ä½çš„æ–‡ä»¶ç³»ç»Ÿå¤§å°ã€æ•°æ®å—çš„æ•°é‡ã€inodeçš„æ•°é‡å’Œæ—¥å¿—ä¸­çš„å—æ•°

super blockåœ¨xv6ç”±å¦å¤–çš„`mkfs`ç¨‹åºæ‰€å¡«å……ï¼Œå…¶å»ºç«‹æœ€åˆçš„æ–‡ä»¶ç³»ç»Ÿ

## log

![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%202.png)

**è¿™ä¸ªnå€¼æ˜¯crash recoveryä¸å¦çš„å…³é”®**

## inodes

æ­¤åŒºåŸŸä¸€ä¸ªblockä¸­æœ‰è®¸å¤šinodesä¿¡æ¯

ä¸€ä¸ªinodeä»£è¡¨ä¸€ä¸ªæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«çš„ä¸¤ç‚¹ä¿¡æ¯å¦‚å³å›¾æ‰€ç¤ºï¼ŒåŒ…å«ï¼š

1. **æ–‡ä»¶å…ƒæ•°æ®**
    - æ–‡ä»¶ç±»å‹
    - æ–‡ä»¶ç¡¬é“¾æ¥æ•°
    - æ–‡ä»¶å¤§å°
    - ...
2. **æ–‡ä»¶æ•°æ®åŸŸå—å·ç´¢å¼•**
    - 12ä¸ªç›´æ¥å—å·ç´¢å¼•(å¯é€šè¿‡å†…å«çš„å—å·ç›´æ¥æ‰¾åˆ°æ–‡ä»¶æ•°æ®å—)
    - 1ä¸ªé—´æ¥å—å·ç´¢å¼•(é€šè¿‡å†…å«å—å·æ‰¾åˆ°ä¸€ä¸ªå†…å« å¤šä¸ªæ•°æ®å—ç›´æ¥å—å·ç´¢å¼• æ•°æ®çš„ä¸€çº§é—´æ¥ç´¢å¼•å—)

![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%203.png)

å¯¹äºxv6ä¸­çš„ä¸€ä¸ªinodeçš„æ•°æ®å—å—å·ç´¢å¼•ä¸­å‡ºç°äº†ä¸€ä¸ªä¸€çº§ç´¢å¼•ï¼Œå½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥å®ç°å¦‚ä¸‹çš„å¤šçº§ç´¢å¼•ï¼Œå¤šå»ºå‡ å±‚æ•°æ®å—çš„â€œç›®å½•â€

![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%204.png)

> **ç›®å½•æ–‡ä»¶**
> 

ä¸Šé¢æˆ‘ä»¬æåˆ°äº†**ç›®å½•**ä¹Ÿæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶ï¼Œåªä¸è¿‡è¿™ä¸ªæ–‡ä»¶çš„æ•°æ®åŸŸæ˜¯æœ¬å±‚ç›®å½•çš„ æ–‡ä»¶å--å—å· çš„entriesã€‚
å¦‚ä¸‹å›¾ï¼š
ç›®å½•inodeçš„ç›´æ¥å—å·ç´¢å¼•æ‰¾åˆ°äº†ç›®å½•æ–‡ä»¶çš„æ•°æ®å—ï¼Œå…¶æ•°æ®å—ç”±ä¸€ä¸ªä¸ªentryæ„æˆï¼Œä¸€ä¸ªentryä»£è¡¨è¯¥ç›®å½•ä¸‹çš„ä¸€ä¸ªæ–‡ä»¶ï¼Œentryä¿å­˜äº†ç›®å½•ä¸‹è¯¥æ–‡ä»¶çš„inodeã€ç›®å½•é¡¹/entryé•¿åº¦ã€æ–‡ä»¶åé•¿åº¦å’Œæ–‡ä»¶å

![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%205.png)

åœ¨Xv6ä¸­æˆ‘ä»¬å°†å…¶è¡¨ç¤ºæˆä¸ºå·¦å›¾ï¼Œä¸€ä¸ªç›®å½•æ–‡ä»¶çš„ä¸€ä¸ªdata blockä¸º1024bytesï¼Œå…¶ä¸­ä¸€ä¸ªentryä¸º16bytesï¼Œä¸€å…±å¯ä»¥è¡¨ç¤º256ä¸ªentry

![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%206.png)

## bitmap

ä½å›¾åŸŸç»´æŠ¤ä¸€ä¸ªdata blocksçš„ä½å›¾ï¼ŒæŸä½å€¼è¡¨ç¤ºæŸä¸ªæ•°æ®å—æ˜¯å¦è¢«å ç”¨

## data

è¿™é‡Œæ˜¯å­˜æ”¾æ–‡ä»¶å†…å®¹æ•°æ®çš„åœ°æ–¹ï¼Œåˆ†é…èµ„æºæ—¶ï¼Œä»¥å—(block)ä¸ºå•ä½

# æ–‡ä»¶ä¸ƒå±‚æŠ½è±¡(è‡ªåº•å‘ä¸Š)

![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled.png)

# 1. Buffer Cache(Linuxä¸­å«Page Cache)

## æ¦‚è§ˆ

buffer cacheå ç”¨ä¸€å®šçš„å†…å­˜å¤§å°ï¼Œåœ¨ç”¨æˆ·ç¨‹åºæƒ³ä½¿ç”¨æ–‡ä»¶æ—¶å°†æ–‡ä»¶blocksåŠ è½½åˆ°buffer cacheä¸­ï¼Œå¹¶ä¸”ä¸€ä¸ªblockåœ¨buffer cacheä¸­çš„copyåŒä¸€æ—¶åˆ»ä»…ä¾›ä¸€æ¡å†…æ ¸çº¿ç¨‹ä½¿ç”¨

buffer cacheä½¿ç”¨LRUç®—æ³•å›æ”¶åœ¨å†…å­˜ä¸­(buffer cacheä¸­)çš„block copyï¼Œä¾›æ–°blocksåŠ è½½åˆ°buffer cacheæ—¶åˆ†é…

sleeplockä¿è¯åŒä¸€blockåœ¨æŸä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ä½¿ç”¨

## buffer cacheä½œç”¨

- **åŒæ­¥**ï¼šä¿è¯ç¡¬ç›˜ä¸Šçš„ä¸€ä¸ªblockåœ¨å†…å­˜ä¸­**åªæœ‰ä¸€ä»½æ‹·è´** ä¸” ä»…æœ‰**ä¸€ä¸ªå†…æ ¸çº¿ç¨‹**ä½¿ç”¨è¿™ä¸ªæ‹·è´
- **ç¼“å­˜**ï¼šç¼“å­˜çƒ­æ•°æ®(å®ç°åœ¨bio.c)

## API

- bread: åœ¨å†…å­˜ä¸­çš„å¯¹ç¡¬ç›˜ä¸Šçš„ä¸€ä¸ªblockçš„copy-- `buf` ä¾›è¿™ä¸ªæ¥å£ä½¿ç”¨
- brelse: å¯¹copyæ“ä½œå®Œæ¯•é‡Šæ”¾å¯¹æ­¤çš„ç‹¬å (å› ä¸ºå¯¹blockçš„ä½¿ç”¨è¦ä¿è¯æŸæ—¶ä»…æœ‰ä¸€ä¸ªå†…æ ¸çº¿ç¨‹)
- bwrite: å°†åœ¨å†…å­˜ä¸­ä¿®æ”¹è¿‡çš„blockçš„copyå†™å…¥ç¡¬ç›˜

## å®ç°

### 1. æ•°æ®ç»“æ„

åŒå‘å¾ªç¯é“¾è¡¨

ä¸åŒä½ç½®çš„èŠ‚ç‚¹è¡¨ç¤ºä¸åŒçš„è®¿é—®çƒ­åº¦ï¼šæœ€è¿‘è¢«çº¿ç¨‹æ“ä½œç»“æŸå¾ˆå¯èƒ½å†æ¬¡æœ‰çº¿ç¨‹æ¥ä½¿ç”¨çš„block bufæ”¾åœ¨é“¾è¡¨é å¤´ä½ç½®ï¼Œå·²ç»è¢«çº¿ç¨‹æ“ä½œå¹¶é‡Šæ”¾å®Œå¾ˆä¹…çš„bufferèŠ‚ç‚¹ä½äºé“¾è¡¨çš„æœ«ç«¯ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬é€‰æ‹©æ–°bufferä¾›äºˆæ–°disk blockåˆ†é…çš„ç›®æ ‡ã€‚

![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%207.png)

buffer cacheä¸ºå›ºå®šå¤§å°(`struct buf buf[NBUF]`)

![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%208.png)

æ¯ä¸€ä¸ªä¾›ç»™å†…æ ¸çº¿ç¨‹ä½¿ç”¨çš„blockåœ¨å†…å­˜ä¸­çš„ç¼“å­˜`struct buf`éƒ½æ˜¯ç”±ä¸€äº›é™„åŠ ä¿¡æ¯+æ•°æ®åŸŸ`data`ç»„æˆï¼Œå¹¶ä¸”ä½¿ç”¨sleeplockä¿è¯ä¸€ä¸ªç¡¬ç›˜ä¸­çš„blockæŸåˆ»ä»…ä¾›ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ä½¿ç”¨ã€‚

validè¡¨ç¤ºè¯¥å—æ˜¯å¦å¯ä»¥ä»diskä¸­åŠ è½½æ•°æ®

**refcntç”¨äºè¡¨ç¤ºåœ¨åˆ»æœ‰å¤šå°‘å†…æ ¸è¿›ç¨‹æƒ³ä½¿ç”¨/æ­£åœ¨ä½¿ç”¨è¯¥å—(æŸåˆ»åªèƒ½æœ‰ä¸€ä¸ªå†…æ ¸çº¿ç¨‹åœ¨ç”¨)**

- **ä¸ºä»€ä¹ˆæ¯ä¸ªblock bufferéƒ½ä½¿ç”¨sleeplockæ¥ä¿æŠ¤è‡ªå·±ï¼Ÿ**
    
     æœ€ä¸»è¦æ˜¯Xv6æ²¡æœ‰ä½¿ç”¨DMAè¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œä¾é UARTçš„ä¸­æ–­è¿›è¡Œä¸­æ–­å¤„ç†ï¼Œä»¥æ­¤æ¥è·å–æ•°æ®(æŒæœ‰spinlockæ—¶å¿…é¡»å…³ä¸­æ–­)
    
    ï¼ˆä½†å…¶å®å°±ç®—æœ‰DMAåœ¨æ•°æ®ä¼ è¾“å¼€å§‹å’Œç»“æŸçš„æ—¶å€™éƒ½è¿˜æ˜¯éœ€è¦ä¸­æ–­è®©CPUä¸DMAäº’åŠ¨å§”æ´¾æ•°æ®æ€»çº¿çš„ä½¿ç”¨æƒçš„ï¼‰
    
    ![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%209.png)
    

### 2. å›¾è§£ä½¿ç”¨buffer cache

![34E73513-2280-4466-8177-4590E5DCC927.jpeg](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/34E73513-2280-4466-8177-4590E5DCC927.jpeg)

## bread -- æŒæœ‰å¯¹blockçš„å”¯ä¸€è¯»å†™ä½¿ç”¨æƒ

å†…æ ¸çº¿ç¨‹å‘buffer cacheè¯·æ±‚è·å–devè®¾å¤‡çš„å—å·ä¸ºblockçš„å—ï¼Œbreadè°ƒç”¨å…¶ä»£ç†bgetè·å–è¿™ä¸ªå—åœ¨buffer cacheä¸­çš„ç¼“å­˜struct buf*

**breadä½¿ç”¨ç¡çœ é”**

![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2010.png)

## bget -- breadçš„ä»£ç†

å…¶bgetå…ˆæ˜¯åœ¨buffer cacheä¸­å¯»æ‰¾ï¼Œå¦‚æœæ‰¾ä¸åˆ°è¯¥å—å°±**ä½¿ç”¨LRUä»é“¾è¡¨è‡ªå°¾å‘å‰å¯»æ‰¾ä¸€ä¸ªå¼•ç”¨ä¸º0çš„bufferä½¿ç”¨**ï¼Œæ ‡è®°bufçš„validä½ä¸º0ï¼Œæœ€ç»ˆå‘ç¡¬ç›˜è¯»å–åŠ è½½åˆ°buffer cacheä¸­æ¥

å¦‚æœä¸€ä¸ªå†…æ ¸çº¿ç¨‹æƒ³ä½¿ç”¨æŸä¸ªbufï¼Œé‚£ä¹ˆå°±ä¼šç›´æ¥ç»™å…¶bufçš„refcntè¿›è¡Œ+1æ“ä½œè®¡æ•°ï¼Œä¸å¿…ç­‰åˆ°è¯¥å†…æ ¸çº¿ç¨‹çœŸæ­£ä½¿ç”¨ä¸Š

![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2011.png)

æ³¨æ„ï¼šæˆ‘ä»¬åœ¨è·å–åˆ°ç›¸åº”blockçš„bufåè¦å¯¹bufåŠ **ç¡çœ é”**ä»…ä¾›å½“å‰å†…æ ¸çº¿ç¨‹ä½¿ç”¨ï¼Œå½“åæ¥çš„æƒ³ä½¿ç”¨è¯¥bufçº¿ç¨‹ä¼šget stuckåœ¨bgetç¬¬ä¸€ä¸ªå¾ªç¯ä¸Šï¼Œè§¦å‘ç¡çœ é”

<aside>
ğŸ”’ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨struct bcacheä¸­é€‰ä¸€ä¸ªstruct bufåï¼Œæˆ‘ä»¬ä¸éœ€è¦ä»ç”³è¯·åˆ°è¯¥bufç”¨æ¥å­˜data blockå ä¸€ç›´åˆ°å½»åº•é‡Šæ”¾çš„è¿‡ç¨‹ä¸­ å¯¹è¯¥struct bufåŠ è‡ªæ—‹é”è¡¨ç¤ºè¿™ä¸ªå—å·²ç»è¢«è£…è½½data blockï¼Œæ­£åœ¨ä½¿ç”¨ï¼Œä¸èƒ½è¢«è£…è½½æ–°çš„data blockå—ï¼Ÿ

ä¸å¯ä»¥

1. åœ¨struct bufè¢«å¤šä¸ªè¿›ç¨‹è½®æµä½¿ç”¨å¯¹åº”ç¡¬ç›˜ç»‘å®šdata blockæœŸé—´ä¸å¯ä»¥åŠ è‡ªæ—‹é”ï¼Œè‡ªæ—‹é”ä¼šå…³é—­ä¸­æ–­ï¼Œæ— æ³•å®ç°æ•°æ®åœ¨CPU<->å†…å­˜<->ç¡¬ç›˜çš„ä¼ è¾“(è¿™ä¾é UARTä¸­æ–­è¿›è¡Œ)
2. åœ¨struct bufä¸­ä½¿ç”¨ä¸€ä¸ªrefcntæ ‡è®°å°±å¥½ï¼Œè¡¨ç¤ºè¯¥struct bufå·²ç»è¢«è£…è½½ä¸”è¢«å¤šå°‘çº¿ç¨‹è®¡åˆ’å¼•ç”¨ï¼Œåªè¦bcacheåœ¨æ¯æ¬¡åˆ†é…struct bufè£…è½½data blockå‰æ£€æŸ¥refcntæ˜¯å¦ä¸º0å³å¯é˜²æ­¢å¯¹bufçš„é‡å¤ä½¿ç”¨
</aside>

## bwrite -- å®é™…å°†å†…å­˜ä¸­çš„æ•°æ®å†™å…¥ç¡¬ç›˜

![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2012.png)

å†…æ ¸çº¿ç¨‹åœ¨è°ƒç”¨å®Œbreadè·å–åˆ°å¯¹blockçš„ä½¿ç”¨æƒåï¼Œå¯¹`struct buf` æ›´æ–°å®Œæ¯•å°±å¯ä»¥è°ƒç”¨bwriteå°†æ•°æ®æ›´æ–°åˆ°ç¡¬ç›˜ï¼Œè‹¥çº¿ç¨‹ä¸å†ä½¿ç”¨è¯¥blockåˆ™å¯ä»¥release

## brelse -- é‡Šæ”¾å¯¹ä¸€ä¸ªblockçš„å”¯ä¸€è¯»å†™ä½¿ç”¨æƒï¼ˆé‡Šæ”¾ç¡çœ é”ï¼‰

å½“ä¸€ä¸ªå†…æ ¸çº¿ç¨‹å®Œæˆå¯¹ä¸€ä¸ªblockçš„ä½¿ç”¨å æœ‰å(è¯»breadå†™bwriteç»“æŸ**å**ä¸å†ä½¿ç”¨)ï¼š

1. å…ˆ å¯¹block bufferçš„ä½¿ç”¨åéœ€è¦å¯¹å…¶ç‹¬å ä½¿ç”¨æƒ(sleeplock)è¿›è¡Œé‡Šæ”¾
2. æ¥ç€è§¦å‘LRUè§„åˆ™å°†bufèŠ‚ç‚¹ç§»åŠ¨è‡³**é“¾è¡¨å¤´éƒ¨**ï¼Œè¡¨ç¤ºè¯¥bufferæœ€è¿‘è¢«ä½¿ç”¨ï¼Œè¿™æ ·åŒæ ·å¼•ç”¨ç­‰å¾…è¯¥block bufferçš„å†…æ ¸çº¿ç¨‹å°±ä¼šè¢«å”¤é†’è¿›è¡ŒæŠ¢å è¯¥èµ„æº

![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2013.png)

`refcnt--`ä»£è¡¨å¯¹è¯¥blockä½¿ç”¨å‡å°‘ä¸€ä¸ªçº¿ç¨‹ï¼Œä»…å½“refcnt == 0æ—¶è¯¥struct bufåœ¨bcacheä¸­å¯å†æ¬¡è¢«åˆ©ç”¨è£…è½½å…¶ä»–disk data block

# 2. Logging -- æœ‰åºç»„ç»‡åˆ©ç”¨Buffer Cache

æ–‡ä»¶ç³»ç»Ÿcrashä¹‹åçš„é—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼Œå…¶å®å°±æ˜¯loggingã€‚è¿™æ˜¯æ¥è‡ªäºæ•°æ®åº“çš„ä¸€ç§è§£å†³æ–¹æ¡ˆã€‚

# Problems -- é€»è¾‘ä¸Šè§†ä¸ºåŸå­æ€§çš„å¤šæ¬¡writeæ“ä½œçš„å®ç°

æœ‰ä¸€äº›è¿ç»­çš„å¤šä¸ªå†™çš„æ“ä½œåœ¨å¯¹æ–‡ä»¶çš„æ“ä½œé€»è¾‘ä¸Šåº”è¯¥è¢«çœ‹åšæˆåŸå­çš„ä¸€ä¸ªæ“ä½œï¼Œç„¶è€Œå®é™…æ‰§è¡Œèµ·æ¥ä¸æ˜¯åŸå­è¿›è¡Œçš„ï¼ˆå†™inodeå±æ€§åˆ°ç¡¬ç›˜ã€å†™bitmapæ ‡è®°æ•°æ®blockå ç”¨ä¸å¦ï¼ŒlogåŒæ­¥åˆ°ç¡¬ç›˜logåŸŸï¼‰ï¼Œcrashå¯èƒ½å‘ç”Ÿåœ¨ä»¥ä¸Šå¤šä¸ªå†™æ“ä½œä¸­çš„æŸä¸€ä¸ªï¼Œé‚£ä¹ˆåç»­çš„å†™æ“ä½œå¦‚æœæ²¡æœ‰ç‰¹æ®Šæªæ–½ï¼Œé‚£ä¹ˆç­‰ç³»ç»Ÿæ¢å¤æ—¶åº”è¯¥éƒ½æ˜¯åç»­æ“ä½œä¸¢å¤±äº†

åæœå¯èƒ½ä¸¥é‡å¯èƒ½ä¸ä¸¥é‡ï¼Œå¯èƒ½inodeæ²¡æœ‰è¢«é‡Šæ”¾ï¼Œå¯èƒ½å¤šä¸ªinodeä½¿ç”¨åŒä¸€ä¸ªblock

# Solutionï¼š

æˆ‘ä»¬å€Ÿç”¨æ•°æ®åº“ä¸­çš„äº‹åŠ¡(transaction)çš„æ¦‚å¿µï¼Œå¯¹å†…æ ¸çº¿ç¨‹çš„å†™æ“ä½œè®°å½•æ—¥å¿—ã€‚

## logè®°å½•å†™æ“ä½œä»¬

å¯¹äºè¿›ç¨‹çš„å†™æ“ä½œï¼ŒXv6æ˜¯è¿™æ ·åšçš„ï¼š
1. ä¸€ä¸ªsyscallæ“ä½œï¼Œå¤§å°åœ¨åˆç†èŒƒå›´å†…çš„å†™æ“ä½œå¯ä»¥çœ‹æˆä¸€ä¸ªåŸå­çš„äº‹åŠ¡ï¼Œé‚£ä¹ˆsyscallè®°å½•å…¶æ¶‰åŠåˆ°çš„æ‰€æœ‰çš„å†™æ“ä½œæˆä¸€ä¸ªæ—¥å¿—(log)ï¼Œå½“æ‰€æœ‰çš„å†™æ“ä½œè¢«æ‰“åŒ…è®°å½•æˆä¸€ä¸ªæ—¥å¿—æ—¶ï¼Œå‘diskå†™ä¸€ä¸ªç‰¹æ®Šçš„commitï¼Œè¡¨ç¤ºè¯¥æ—¥å¿—ä¸ºcompleteçŠ¶æ€(æ‰€æœ‰å†™æ“ä½œè®°å½•æˆlogçš„ä»»åŠ¡å®Œæˆ)
2. ä¹‹åè¿™ä¸ªsyscallå†å»å°†æ‰€æœ‰è¦çœŸæ­£å†™å…¥çš„æ•°æ®ä»logåŸŸä¸€æ¬¡äº‹åŠ¡ä¸­ç¼“å­˜çš„data block(s) copies è‡³diskç›¸åº”éœ€è¦è¢«å†™å…¥çš„data blockä½ç½®
3. å½“å†™æ“ä½œå®Œæˆï¼Œsyscallè¿˜ä¼šåœ¨diskæ¸…é™¤è¯¥log

## Implementation

![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2014.png)

## log åŸŸåœ¨ç¡¬ç›˜ä¸Šçš„å¸ƒå±€

logåŸŸæœ‰å›ºå®šçš„å¤§å°ï¼Œæˆ‘ä»¬çœ‹åˆ°logåŸŸåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š

- A header blockï¼š
    - è®¡æ•°Nï¼šåœ¨ä¸€æ¬¡å·²ç»æäº¤çš„äº‹åŠ¡/commitä¸­ï¼Œæ¶‰åŠåˆ°äº†å¯¹Nä¸ªdata blocksçš„å†™
    - Slot Arrayï¼šè®°å½•åœ¨è¿™æ¬¡å·²ç»æäº¤çš„äº‹åŠ¡/commitä¸­ï¼Œæ¶‰åŠåˆ°çš„Nä¸ªdata blockçš„block numbersé›†åˆ
- Log blocks: (ä¸­è½¬åŠŸèƒ½)
    
    å¯¹æ”¹å†™äº†çš„data blockåœ¨å†…å­˜ä¸­çš„**struct buf**è¿›è¡Œç¼“å­˜ï¼Œç­‰å¾…è¢«å†™åˆ°ç›¸åº”çš„data block
    

## æ•°æ®ç»“æ„

- superblockä¸­è®°å½•äº†logåŸŸçš„èµ·å§‹å—å·å’Œç»™logåŸŸåˆ†é…äº†å¤šå°‘ä¸ªå—
- struct logï¼šç”±å¤´éƒ¨`struct logheader`å’Œå…¶ä»–logåŸŸé™„å±ä¿¡æ¯ç»„æˆ
    
    ![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2015.png)
    
- `n`
    
    ä½œä¸ºcounterï¼Œå…¶å€¼æœ‰ä¸¤ç§æƒ…å†µ -- 0ä¸é0
    
    - 0å€¼ï¼šç›®å‰åœ¨logåŸŸä¸­æ²¡æœ‰äº‹åŠ¡ï¼Œæ—¥å¿—å·²ç»ä»bcacheä¸­åˆ°è¾¾ç¡¬ç›˜logåŸŸä¸”è¢«å®Œå…¨è½¬ç§»è‡³home location
    - é0å€¼ï¼šè¿™ä¸ªäº‹åŠ¡ä¸­ç›®å‰è¢«ä¿®æ”¹çš„blockæ•°
        - å¦‚æœæ˜¯åœ¨crash recoveryæ—¶æ£€æµ‹ç¡¬ç›˜logåŸŸè¯¥å€¼ï¼Œè‹¥ä¸ºé0è¯æ˜ä¸€å®šæ˜¯ä¹‹å‰commitäº†ä½†æ²¡æœ‰å†™å…¥home locationï¼Œè¯¥äº‹åŠ¡å®Œæ•´ï¼Œåˆ™æ¢å¤æ‰§è¡Œ
        - å¦‚æœæ˜¯åœ¨å†…å­˜ä¸­æ“ä½œblockæ—¶æœªcommitå‰çš„å€¼ï¼Œé‚£åªèƒ½è¯´æ˜å½“å‰äº‹åŠ¡ä¸­ï¼Œè¿™ä¸ªäº‹åŠ¡ä¸­ç›®å‰è¢«ä¿®æ”¹çš„blockæ•°ï¼Œä¸èƒ½è¯´æ˜å·²ç»è¢«commitåˆ°ç¡¬ç›˜logåŸŸäº†
    
    > **å…¨å±€å˜é‡`struct log log;`ä¸­nå€¼è®¡æ•°è§„åˆ™ï¼š**
    äº‹åŠ¡å¼€å§‹ä¹‹å‰ï¼šå†…å­˜ä¸­ä¸º0
    äº‹åŠ¡å¼€å§‹è®°å½•ä¼—å¤šå†™æ“ä½œ åˆ° commitå‰ï¼šå†…å­˜ä¸­ä¸ºé0å€¼ï¼ŒåŠ¨æ€å˜åŒ–
    å¼€å§‹commit log cache blockåˆ°commit log cache blockç»“æŸä¹‹å‰ï¼šç£ç›˜ä¸Šä¸º0
    å¼€å§‹commit log headeråˆ°commit log headerç»“æŸä¹‹å‰ï¼šç£ç›˜ä¸Šä¸º0
    å¼€å§‹å°†ç£ç›˜ä¸Šlog cache blockå†™å…¥home locationåˆ°å†™å…¥ç»“æŸä¹‹å‰ï¼šç£ç›˜ä¸Šä¸ºé0å€¼
    å®Œæˆäº‹åŠ¡æ¸…é™¤logï¼šç£ç›˜ä¸Šä¸º0å€¼
    > 
- `outstanding`
    
    å½“å‰æ­£åœ¨è¿›è¡Œ(è°ƒç”¨äº†begin_op()ä½†æ²¡æœ‰è°ƒç”¨end_op()) çš„FS Syscallæ•°/äº‹åŠ¡æ•°
    
    **å½“outstandingä¸º0å³åœ¨æœ¬æ¬¡commitä¸­æ²¡æœ‰äº‹åŠ¡åœ¨æ‰§è¡Œåï¼šæ‰§è¡Œcommit (æœ€åä¸€ä¸ªäº‹åŠ¡çš„end_op()è§¦å‘)**
    
- `committing`
    
    å€¼ï¼š0 or 1
    
    æ˜¯å¦æ­£åœ¨committingä¸­ï¼ˆcommitã€install home locationã€bzreo meta-dataï¼‰
    

## å¦‚ä½•ä¿è¯äº‹åŠ¡åŸå­æ€§ï¼š

<aside>
ğŸ’¡ **æ¾„æ¸…æ¦‚å¿µï¼š
äº‹åŠ¡ï¼šä¸€å¯¹ begin_op() å’Œ end_op() ç»„æˆä¸€ä¸ªäº‹åŠ¡ï¼Œä¿è¯è¦ä¹ˆå…¨å‘ç”Ÿï¼Œè¦ä¹ˆä»€ä¹ˆéƒ½ä¸å‘ç”Ÿ
commitï¼šä¸€æ¬¡commitä¸­å¯èƒ½åªæœ‰ä¸€ä¸ªäº‹åŠ¡ï¼Œä¹Ÿå¯èƒ½æœ‰å¤šä¸ªäº‹åŠ¡(é€šè¿‡struct logä¸­çš„outstandingæ ‡è®°) -- å¯ä»¥ä»»åŠ¡ä¸€ä¸ªcommitæ˜¯ä¸ªæ›´å¤§çš„äº‹åŠ¡**

</aside>

1. æˆ‘ä»¬å¼€å§‹ä¸€ä¸ªäº‹åŠ¡é€šè¿‡begin_op()æ ‡å¿—äº‹åŠ¡å¼€å§‹
    
    ![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2016.png)
    
    å½“logä¸åœ¨å†™å…¥ç¡¬ç›˜æ—¶ï¼Œä¸”æœ‰è¶³å¤Ÿçš„ç©ºé—´å®¹çº³æ–°æ—¥å¿—å†™æ—¶ï¼š
    
    å¯¹å…¨å±€struct log->outstanding++ è¡¨ç¤ºåœ¨æœ¬æ¬¡commitä¸­ï¼Œå¤šä¸€ä¸ªäº‹åŠ¡ï¼Œå¹¶ä¸”è¯¥äº‹åŠ¡å æœ‰è¯¥commitä¸­ï¼Œåˆ«å¼€å§‹commitæäº¤
    
2. åœ¨æ­¤äº‹åŠ¡ä¸­ï¼Œå¯èƒ½å¤šæ¬¡å†™æ“ä½œæˆ‘ä»¬æ¯æ¬¡éƒ½è¦è¿›è¡Œæ—¥å¿—è®°å½•
    
    ![writei()](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2017.png)
    
    writei()
    
    ![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2018.png)
    
    log_write()çš„é€»è¾‘å°±æ˜¯æˆ‘ä»¬å°†ç¨‹åºå¸Œæœ›çš„å†™æ“ä½œæš‚å­˜åˆ°æˆ‘ä»¬å†…å­˜ä¸­çš„logåŸŸä¸­ï¼Œå¹¶åŠæ—¶æ›´æ”¹struct logçš„headerä¿¡æ¯
    
3. ä»¥filewriteä¸ºä¾‹ï¼Œåœ¨äº‹åŠ¡ç»“æŸåï¼Œend_op()è¿›è¡Œæ ‡è®°
    
    ![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2019.png)
    
    ![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2020.png)
    
    å¯¹æœ¬æ¬¡äº‹åŠ¡ç»“æŸæ ‡è®°outstanding--ï¼Œå¹¶å¯¹å¯èƒ½å› ä¸ºæ—¥å¿—ç©ºé—´ä¸è¶³çš„å†™è¿›ç¨‹å”¤é†’ï¼Œå¦‚æœæœ¬æ¬¡äº‹åŠ¡ç»“æŸä»…ä»…æ˜¯å¤šæ¬¡commitä¸­å…¶ä¸­ä¹‹ä¸€ï¼Œå¹¶ä¸æ˜¯æœ€åä¸€ä¸ªï¼Œé‚£å°±ç»“æŸï¼›ä½†ä¸€æ—¦å‘ç°æœ¬æ¬¡äº‹åŠ¡æ˜¯è¿™ä¸ªcommitä¸­çš„æœ€åä¸€ä¸ªï¼Œé‚£ä¹ˆå°±æ‰§è¡Œcommitæ“ä½œå¹¶æ ‡è®°æ­£åœ¨commitä¸­ï¼Œåˆ«å¼€å§‹æ–°çš„commitæ–°çš„äº‹åŠ¡ã€‚
    
    ## ç´¯è®¡åˆ°ä¸€ä¸ªcommitä¸­çš„ å¤šä¸ªç³»ç»Ÿè°ƒç”¨çš„å†™æ“ä½œä»¬(å¤šä¸ªäº‹åŠ¡) çš„å¹¶å‘ -- group commit
    
    **æˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°ï¼š**
    
    åœ¨ä¸€æ¬¡commitä¸­ï¼šåˆšå¼€å§‹`log.outstanding` ä¸º0ï¼Œè¿›ç¨‹Açš„begin_op()æ‰§è¡Œå®Œæ¯•`log.outstanding++`è¿›å…¥è¿›ç¨‹Açš„äº‹åŠ¡ä¸­ï¼Œæ­¤æ—¶`log.outstanding` ä¸º1ï¼Œè¿›ç¨‹Bæ­¤æ—¶å¼€å§‹æ‰§è¡Œbegin_op()`log.outstanding++` ï¼Œä½¿å¾—`log.outstanding` ä¸º2ï¼Œè‹¥æ­¤æ—¶è¿›ç¨‹Açš„äº‹åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œè°ƒç”¨end_op()ä½¿å¾—`log.outstanding--`åï¼Œ`log.outstanding` ä¸º1ï¼Œè¿›ç¨‹Aåœ¨end_opä¸­åˆ¤æ–­`log.outstanding` è¿˜ä¸ä¸º0ï¼Œä¸èƒ½è¿›è¡Œcommitæäº¤ï¼Œæ­¤æ—¶è¿›ç¨‹Aå°±ç»“æŸä»–çš„ä½¿å‘½ã€‚ä¸€æ—¦è¿›ç¨‹Bå®Œæˆä»–çš„äº‹åŠ¡ï¼Œè°ƒç”¨end_op()ä½¿å¾—`log.outstanding--` ï¼Œæ£€æµ‹åˆ°æ­¤æ—¶`log.outstanding` ä¸º0ï¼Œé‚£ä¹ˆå°±è§¦å‘commitæäº¤åˆ°ç¡¬ç›˜ï¼Œæ¥ç€å®Œæˆå†™å…¥commit log to the disk log partationï¼Œwrite the log partation to home locationsçš„å·¥ä½œ 
    
    ![è®°å¾—commitç»“æŸè¦æ¢å¤nä¸º0å¹¶æ›´æ–°è¯¥æ—¥å¿—ä¸º0åˆ°ç¡¬ç›˜](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2021.png)
    
    è®°å¾—commitç»“æŸè¦æ¢å¤nä¸º0å¹¶æ›´æ–°è¯¥æ—¥å¿—ä¸º0åˆ°ç¡¬ç›˜
    
    **commit()çš„å·¥ä½œæœ‰äº”ä¸ªéƒ¨åˆ†ï¼Œå¦‚æœcrashå‘ç”Ÿåœ¨write_headç»“æŸä¹‹å‰é‚£ä¹ˆå°±æ— æ³•æ¢å¤æœ¬æ¬¡commitï¼Œå‘ç”Ÿåœ¨logå·²ç»å®Œæ•´å†™å…¥diskåæ˜¯å¯ä»¥åœ¨crashåå®Œæ•´æ¢å¤è¯¥commitä¸­æ‰€æœ‰çš„äº‹åŠ¡çš„**
    
    ![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2022.png)
    
    å°†å†…å­˜ä¸­çš„struct logçš„ç¼“å­˜æ•°æ®åŸŸstruct bufå…ˆå†™å…¥ç¡¬ç›˜çš„logåŸŸä¸­çš„ç¼“å­˜åŒº
    
    ![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2023.png)
    
    å†å°†å†…å­˜ä¸­çš„struct logä¸­çš„headerå†™å…¥ç¡¬ç›˜ä¸­logåŸŸçš„headeréƒ¨åˆ†
    
    ![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2024.png)
    
    å†å®Œæˆå¯¹ç¡¬ç›˜ä¸­çš„logåŸŸæ•°æ®å‘ä»–ä»¬è‡ªå·±çš„home locationè¿ç§»çš„è¿‡ç¨‹ï¼Œå¦‚æœè¿™ä¸€æ­¥æ²¡æœ‰æ‰§è¡Œå®Œæ¯•å°±crashäº†ä¹Ÿä¸è¦ç´§ï¼Œå› ä¸ºæœ¬æ¬¡commitçš„æ‰€æœ‰äº‹åŠ¡ä¿®æ”¹çš„data blockæœ‰å¤šå°‘ã€å—å·æ˜¯å“ªäº›ã€æ›´æ–°åçš„å—å†…å®¹æ˜¯ä»€ä¹ˆç»Ÿç»Ÿå·²ç»å†™å…¥åˆ°äº†ç¡¬ç›˜çš„logåŸŸï¼Œå¼€æœºæ£€æµ‹æ¢å¤æ‰§è¡Œinstall_transå°±å¥½
    
    è‡ªæ­¤ä¹‹åï¼Œæœ¬æ¬¡commitä¸­æ‰€æœ‰äº‹åŠ¡å…¨éƒ¨ç»“æŸï¼Œæˆ‘ä»¬ä¹Ÿè¦å°†å†…å­˜å’Œç£ç›˜ä¸­çš„logåŸŸæ¸…é™¤ï¼Œå› ä¸ºæ•°æ®å·²ç»å®‰å…¨å†™å…¥åˆ°ä»–ä»¬çš„ç›®çš„åœ°äº†ã€‚
    
    ### æ¢å¤æ–¹æ³•
    
    åœ¨rebootåï¼Œä»»ä½•çº¿ç¨‹å¼€å§‹æ‰§è¡Œä¹‹å‰ï¼š
    
    - æ£€æŸ¥ç¡¬ç›˜ä¸Šçš„logåŸŸï¼ŒæŸ¥çœ‹å¤´éƒ¨nå€¼ï¼Œé0åˆ™è¡¨æ˜ä¸Šæ¬¡crash**å‘ç”Ÿåœ¨** **å®Œæˆäº†å‘ç¡¬ç›˜logåŸŸcommit** ä½†æ˜¯ åœ¨æ­¤ä¹‹åçš„ä»ç¡¬ç›˜logåŸŸå‘home home locationè¿å¾™ å¹¶ **æ¸…é™¤logä¹‹å‰**ï¼Œæˆ‘ä»¬å¯ä»¥ä¿è¯å†™æ“ä½œæ¢å¤ï¼šå› æ­¤æˆ‘ä»¬ä¼šå°†logä¸­çš„å†™æ“ä½œå†…å®¹é‡æ–°replayä¸€éï¼Œå¹¶æ¸…ç†logåŸŸ
        
        ![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2025.png)
        
        ![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2026.png)
        
        ![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2027.png)
        
    - å¦‚æœæ˜¯ç¡¬ç›˜logåŸŸheaderçš„nå€¼ä¸º0ï¼Œè¡¨ç¤ºcrashå‘ç”Ÿåœ¨commit logåˆ°ç¡¬ç›˜logåŸŸä¹‹å‰ï¼Œå°†å…¶æ“ä½œè®°å½•å¿½ç•¥ï¼Œæ•°æ®ä¸¢å¤±
    
    <aside>
    ğŸ’¡ æ‰€ä»¥è¯´å½“ä¸€ä¸ªæ—¥å¿—æ‰€å±çš„æ‰€æœ‰å†™æ“ä½œçœŸæ­£å®Œæˆåï¼Œæ—¥å¿—åº”è¯¥æ˜¯ä¸è§äº†çš„ï¼Œå¦‚æœcrashåæ—¥å¿—è¿˜åœ¨è¯´æ˜é‚£ä¸€è¿ä¸²å†™åˆ°home locationæ“ä½œå¤±è´¥ï¼Œè¿˜æ˜¯ä¼šæ¢å¤å†™æ“ä½œä¿è¯å…¶æˆåŠŸï¼Œä½†å¦‚æœæ—¥å¿—nå€¼ä¸º0ï¼Œåˆ™è¯´æ˜æ—¥å¿—ä¸å®Œæ•´æˆ–è€…æ— æ—¥å¿—ï¼Œé‚£ä¹ˆå°†è¢«recovery codeå¿½ç•¥ï¼Œè¿™äº›å†™æ“ä½œä¸¢å¤±
    
    </aside>
    
    **âˆ´** è¿™æ ·å°±ä¿è¯äº†ä¸€ä¸ªcommit logä¸­çš„å†™æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œäº†ï¼Œè¦ä¹ˆå…¨éƒ¨æ²¡æœ‰æ‰§è¡Œ
    
    ## ç‰¹æ€§ï¼šå¿«æ¢å¤
    
    è¿™ç§å¿«é€Ÿæ¢å¤ï¼ˆFast Recoveryï¼‰ï¼šåœ¨é‡å¯ä¹‹åï¼Œæˆ‘ä»¬ä¸éœ€è¦åšå¤§é‡çš„å·¥ä½œæ¥ä¿®å¤æ–‡ä»¶ç³»ç»Ÿï¼Œåªéœ€è¦éå¸¸å°çš„å·¥ä½œé‡ã€‚è¿™é‡Œçš„å¿«é€Ÿæ˜¯ç›¸æ¯”å¦ä¸€ä¸ªè§£å†³æ–¹æ¡ˆæ¥è¯´ï¼Œåœ¨å¦ä¸€ä¸ªè§£å†³æ–¹æ¡ˆä¸­ï¼Œä½ å¯èƒ½éœ€è¦è¯»å–æ–‡ä»¶ç³»ç»Ÿçš„æ‰€æœ‰blockï¼Œè¯»å–inodeï¼Œbitmap blockï¼Œå¹¶æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿæ˜¯å¦è¿˜åœ¨ä¸€ä¸ªæ­£ç¡®çš„çŠ¶æ€ï¼Œå†æ¥ä¿®å¤ã€‚è€Œloggingå¯ä»¥æœ‰å¿«é€Ÿæ¢å¤çš„å±æ€§ã€‚
    

# sys_write()çš„åŸå­æ€§ï¼Ÿ

å‚è€ƒï¼š

[å†æ¢Linuxå†…æ ¸writeç³»ç»Ÿè°ƒç”¨æ“ä½œçš„åŸå­æ€§_Netfilter,iptables/OpenVPN/TCP guard:-(-CSDNåšå®¢_writeç³»ç»Ÿè°ƒç”¨](https://blog.csdn.net/dog250/article/details/78879600)

[What If Two Processes Write to the Same File Simultaneously](https://walkerlala.github.io/archive/what-if-write-to-the-same-file.html)

- MIT 6.S081 2020 ä¸­æ˜¯è¿™æ ·è§£é‡Šç³»ç»Ÿè°ƒç”¨çš„åŸå­æ€§çš„ï¼š
    
    <aside>
    ğŸ’¡ å®ƒå¯ä»¥ç¡®ä¿æ–‡ä»¶ç³»ç»Ÿçš„ç³»ç»Ÿè°ƒç”¨æ˜¯**åŸå­æ€§**çš„ã€‚æ¯”å¦‚ä½ è°ƒç”¨**create/write**ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™äº›ç³»ç»Ÿè°ƒç”¨çš„æ•ˆæœæ˜¯è¦ä¹ˆå®Œå…¨å‡ºç°ï¼Œè¦ä¹ˆå®Œå…¨ä¸å‡ºç°ï¼Œè¿™æ ·å°±é¿å…äº†ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨åªæœ‰éƒ¨åˆ†å†™ç£ç›˜æ“ä½œå‡ºç°åœ¨ç£ç›˜ä¸Šã€‚
    
    å¯¹äºè¿™ä¸ªè¯´æ³•ï¼Œæˆ‘ä»¬åªèƒ½è¯´åœ¨å†™å¤§å°åœ¨ä¸€å®šèŒƒå›´å†…æ•°æ®æ—¶ï¼Œæ˜¯ä¸Šè¿°æè¿°çš„åŸå­çš„
    
    </aside>
    
    ## å¤šä¸ªè¿›ç¨‹ä½¿ç”¨writeç³»ç»Ÿè°ƒç”¨å†™ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œwriteèƒ½ä¿è¯çš„æ˜¯ä»€ä¹ˆï¼Ÿ
    
    ### é—®é¢˜å¼•å…¥ ä¸ èƒŒæ™¯ä»‹ç»ï¼š
    
    ![*The Linux Programming Interface*](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2028.png)
    
    *The Linux Programming Interface*
    
    åœ¨Xv6å’ŒLinuxä¸­ï¼Œå…³äº æ–‡ä»¶æè¿°ç¬¦ <-> ç³»ç»Ÿå…¨å±€æ‰“å¼€æ–‡ä»¶æè¿°è¡¨ <-> ç³»ç»Ÿinodeè¡¨ çš„å¯¹åº”å…³ç³»å¦‚Figure 5-2æ‰€ç¤ºï¼Œå…¶ä¸­inodeå”¯ä¸€å¯¹åº”æ–‡ä»¶ç³»ç»Ÿä¸­å”¯ä¸€çš„æ–‡ä»¶ã€‚ï¼ˆè§sys_open()å®ç°ï¼‰
    
    åœ¨Xv6ä¸­ï¼Œæ¯ä¸ªè¿›ç¨‹æœ‰ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦è¡¨ï¼š
    
    ![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2029.png)
    
    è¯¥è¡¨çš„ä¸‹æ ‡å³æ–‡ä»¶æè¿°ç¬¦ï¼Œè¯¥è¡¨ä¸­çš„struct file* å³ä¸ºç³»ç»Ÿå…¨å±€æ‰“å¼€æ–‡ä»¶æè¿°è¡¨ftableä¸­çš„æŸä¸€æ¡
    
    ![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2030.png)
    
    å¯ä»¥çœ‹åˆ°ï¼Œstruct fileä¸­struct inode *ipé¡¹æŒ‡å‘æŸä¸€æ–‡ä»¶inodeï¼Œä½†inodeåªèƒ½å¯¹åº”å”¯ä¸€çš„æ–‡ä»¶
    
    ![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2031.png)
    
    æ‰€ä»¥å°±æœ‰äº†Figure 5-2 çš„å¯¹åº”å…³ç³»ï¼š
    
    - å¤šä¸ªè¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦(fork) æˆ– åŒä¸€è¿›ç¨‹çš„ä¸åŒä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦(dupå¾—æ¥) å¯ä»¥æŒ‡å‘åŒä¸€struct file
    - å¤šä¸ªstruct fileå¯ä»¥æŒ‡å‘åŒä¸€inode
    - å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦å„è‡ªæŒ‡å‘ä¸åŒçš„struct fileï¼Œä½†struct fileä»¬éƒ½æŒ‡å‘åŒä¸€inode
    
    ç”±äºè¿™æ ·çš„åœºæ™¯å­˜åœ¨ï¼Œæˆ‘ä»¬å°±ä¸å¾—ä¸æ€è€ƒå…³äºå†™å®Œæ•´æ€§ã€åŸå­äº‹åŠ¡æ€§çš„é—®é¢˜ã€‚
    
    **åœ¨è¿™å‡ ç§æƒ…å†µä¸‹ï¼š**
    
    1. å¦‚æœæ˜¯åŒä¸€è¿›ç¨‹çš„ä¸¤ä¸ªçº¿ç¨‹å†™åŒä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦
    
    2. çˆ¶å­è¿›ç¨‹å„è‡ªä¸åŒçš„æ–‡ä»¶æè¿°ç¬¦/ä¸€ä¸ªè¿›ç¨‹å†…dupçš„ä¸åŒä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä½†æŒ‡å‘åŒä¸€ä¸ªsystem open file tableä¸­æŸä¸€é¡¹
    
    > æƒ…å†µ1ã€2è¿˜éƒ½æ˜¯æŒ‡å‘åŒä¸€struct fileçš„æƒ…å†µ
    > 
    
    3. ä¸¤ä¸ªè¿›ç¨‹å„è‡ªæ‰“å¼€åŒä¸€æ–‡ä»¶åˆ›å»ºçš„ä¸¤ä¸ªä¸åŒæ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶å„è‡ªæŒ‡å‘çš„system open file tableä¸­çš„ä¸åŒé¡¹ï¼Œä½†è¿™ä¸¤ä¸ªä¸åŒé¡¹åˆæŒ‡å‘åŒä¸€inode
    
    **é—®é¢˜:**
    
    I. ä¼šç¡®ä¿ä¸¤ä¸ªwriteéƒ½å†™å…¥æŒ‡å®šå­—èŠ‚å¤§å°çš„æ•°æ®åˆ°æ–‡ä»¶å—ï¼Ÿ(ä¸€ä¸ªçº¿ç¨‹è¦å†™1Gæ•°æ® å¦ä¸€ä¸ªä¹Ÿå†™1G èƒ½ä¿è¯å…¨éƒ¨å†™åˆ°å—)
    
    II. ä¼šä¿è¯ä¸€æ¬¡writeè°ƒç”¨å¯¹æ–‡ä»¶å†™çš„ç‹¬å å—ï¼Ÿ
    (å‡å¦‚çº¿ç¨‹Aå†™'aaaa...aaa'çº¿ç¨‹Bå†™'bbbb...bbb'ä¼šå‡ºç°'aaababbaab..è¿™æ ·çš„åºåˆ—å—)
    
    III. å¦‚æœæ— æ³•åšåˆ°ä¸€æ¬¡æ€§ä¸ä¸­æ–­å†™å®ŒæŒ‡å®šå¤§å°å­—èŠ‚æ•°æ®ï¼Œé‚£æœ€ç»ˆè¡¨ç°æ˜¯è¯¥æ¬¡å†™æ“ä½œè¢«æ’¤é”€ï¼Œç›¸å½“äºæ²¡æ‰§è¡Œï¼Œè¿˜æ˜¯å°†å·²ç»æ‰§è¡Œäº†çš„ç•™åœ¨æ–‡ä»¶é‡Œå¹¶å¯¹åº”ç›¸åº”çš„æ–‡ä»¶å¤§å°
    
    IV. è¿™ä¸‰ç§ä¸åŒçš„å¹¶è¡Œå†™ï¼Œå†…æ ¸å®ç°æ˜¯ç»™è°åŠ é”ï¼Ÿinode? æ–‡ä»¶æè¿°ç¬¦? system open file entry? ä¿è¯äº†ä»€ä¹ˆ
    
    [writeçš„åŸå­å†™ï¼Ÿ-- in Linux Kernel](write%E7%9A%84%E5%8E%9F%E5%AD%90%E5%86%99%EF%BC%9F--%20in%20Linux%20Kernel%20e6de59c87b704d9ab269749abf83b58b.md) in Linux Kernel
    
    ### è§£å†³ï¼š
    
    `write() --> sys_write() --> filewrite()`
    
    ![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2032.png)
    
    æˆ‘ä»¬å¯ä»¥åœ¨filewrite()ä¸­çœ‹åˆ°ï¼šæ— è®ºæ˜¯å¯¹åŒä¸€struct fileå¹¶å‘å†™è¿˜æ˜¯ä¸åŒstruct fileä½†æŒ‡å‘åŒä¸€inodeå¹¶å‘å†™ï¼Œéƒ½æ˜¯ä¸ä¼šå‡ºç°æŸä¸ªè¿›ç¨‹åœ¨ä¸€æ¬¡writei()ä¸­ï¼Œå¦ä¸€å†™æ“ä½œå’Œé‚£ä¸ªwritei()åœ¨ä¸€æ¬¡writei()è°ƒç”¨ä¸­è½®æµäº¤é”™å†™ï¼Œå› ä¸ºåªè¦æƒ³è°ƒç”¨writei()è¿›è¡Œå†™éƒ½æ˜¯éœ€è¦å¯¹inodeåŠ é”çš„ã€‚
    
    ![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2033.png)
    
    ![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2034.png)
    
    **æ®æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼š**
    
    1. **writei()çš„å†™æ˜¯äº‹åŠ¡åŸå­çš„ï¼ŒXv6ä¸­å®ç°çš„writei()ä¸­ï¼Œå¦‚æœå†™ä¸åˆ°æ‹Ÿå®šå­—èŠ‚å¤§å°ï¼Œé‚£ä¹ˆå°±æ”¾å¼ƒè¯¥æ­¤å†™ï¼Œä¸æ›´æ–°æ–‡ä»¶inodeä¸­çš„å¤§å°ä¿¡æ¯ï¼Œå¹¶è¿”å›-1è¡¨ç¤ºå†™å¤±è´¥ï¼Œå½“ç„¶æ‰§è¡Œiupdate()æ—¶inodeçš„struct bufè¢«å†™å…¥åï¼Œè¿”å›åˆ°writeæ—¶æ‰§è¡Œend_op()ä¸”outstanding == 0æ—¶æ‰å†™å…¥ç¡¬ç›˜æ‰ç®—çœŸæ­£è¾¾æˆç›®çš„**
    2. å½“æŸä¸ªè¿›ç¨‹writeå†™å…¥å­—èŠ‚å°äºç­‰äº`int max **=** ((MAXOPBLOCKS**-**1**-**1**-**2) **/** 2) ***** BSIZE;` ï¼ˆé˜²æ­¢æº¢å‡ºlogåŸŸï¼‰
        
        æˆ‘ä»¬å°±å¯ä»¥ä¿è¯ï¼š
        
        1. è¿™æ¬¡å¯¹æŸä¸ªæ–‡ä»¶çš„write()ä»…ç”±å½“å‰è¿›ç¨‹çš„å†™å æœ‰ï¼Œå…¶ä»–è¿›ç¨‹ä¸å¯èƒ½å†™è¯¥æ–‡ä»¶**ï¼ˆç”±äºåœ¨å•æ­¤writeiå‰éƒ½ä¼šç»™inodeåŠ é”ï¼‰**
            
            > è‹¥è¿›ç¨‹Aå†™"aaa...aaa"(**å°äºç­‰äºmaxå­—èŠ‚**)ï¼Œè¿›ç¨‹Bå†™"bbb..bb"(**å°äºç­‰äºmaxå­—èŠ‚**)ï¼Œä¸¤ä¸ªè¿›ç¨‹éƒ½å»å†™åŒä¸€æ–‡ä»¶ï¼Œå…ˆæŠ¢åˆ°inodeé”çš„å…ˆå®Œæ•´å†™å®Œï¼Œæ‰èƒ½è½®åˆ°å¦ä¸€ä¸ªï¼Œæ–‡ä»¶ä¸ä¼šå‡ºç°"aaabababaaabbb.."è¿™æ ·çš„åºåˆ—
            > 
        2. æœ¬æ¬¡å†™è¦ä¹ˆå‘ç”Ÿäº†ï¼Œè¦ä¹ˆæ²¡å‘ç”Ÿï¼ˆinodeæ²¡æ›´æ–°æ–‡ä»¶sizeï¼Œfilewrite() return -1ï¼‰
            
            ![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2035.png)
            
    3. å¦‚æœä¸€æ¬¡write()è°ƒç”¨æ‹Ÿå®šå¤§å°å¤§äºmaxå€¼ï¼Œwrite()åœ¨å†™å®Œä¸€æ¬¡maxå¤§å°å­—èŠ‚åç”±äºinodeè§£é”å¯ä»¥è¢«å…¶ä»–å¯¹åŒæ ·æ–‡ä»¶å†™è¿›ç¨‹æŠ¢å åŠ é”inodeï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°å¤šè¿›ç¨‹å†™äº¤é”™(ä»¥â‰¤maxä¸ºå•ä½çš„äº¤é”™)ï¼Œä½†ä¸ä¼šäº§ç”Ÿè¦†ç›–ï¼Œä¹Ÿä¸èƒ½ä¿è¯write()çš„å†™å®Œæ•´æ€§
        
        
    
    <aside>
    ğŸ’¡ ä½†Xv6çš„å®ç°writeæ–¹å¼æ˜¯ä¸€ä¸ªä¸æ˜æ™ºçš„ï¼Œé²æ£’æ€§å·®çš„ï¼Œåœ¨Linuxä¸­writeæ‰§è¡Œå®Œåä¼šè¿”å›çš„å¤§å°ä¸ºå®é™…å†™å…¥å­—èŠ‚å¤§å°ï¼Œè€Œä¸æ˜¯åªæœ‰æ‹Ÿå®šå€¼å’Œ-1ä¸¤ç§
    Linuxä¸‹å®ç°æ˜¯ä¸ªå¤æ‚çš„è¯é¢˜ï¼Œç¬”è€…ç›®å‰ä¹Ÿæ²¡æœ‰å¤ªæ¸…æ™°ï¼Œç•™ä½œä»¥åæ€è€ƒå®éªŒè§£å†³ **~~ï¼ˆTODOï¼‰~~ å·²è§£å†³ å¾…æ•´ç† [writeçš„åŸå­å†™ï¼Ÿ-- in Linux Kernel](write%E7%9A%84%E5%8E%9F%E5%AD%90%E5%86%99%EF%BC%9F--%20in%20Linux%20Kernel%20e6de59c87b704d9ab269749abf83b58b.md)**
    
    </aside>
    
    æˆ‘ä»¬æ¥çœ‹çœ‹Xv6ä¸­ï¼Œwriteä»…åœ¨å†™å…¥å†…å®¹å°äºç­‰äº((10**-**1**-**1**-**2) **/** 2) ***** BSIZEæ—¶æ‰æ»¡è¶³è¯¾ç¨‹ä¸­æ‰€æè¿°çš„â€œåŸå­æ€§â€
    
    ä¸‹é¢æ˜¯æµ‹è¯•Xv6æ–‡ä»¶ç³»ç»Ÿä¸€æ¬¡writeæœ€å¤šèƒ½ä¿éšœå¤šå°‘å­—èŠ‚å®Œæ•´å†™å…¥çš„æµ‹è¯•ç¨‹åºã€‚
    
    ```c
    user program:
    
    #include "kernel/types.h"
    #include "kernel/stat.h"
    #include "user/user.h"
    #include "kernel/fs.h"
    #include "kernel/fcntl.h"
    
    void main()
    {
        int fd = open("TEST2", O_CREATE | O_RDWR);
        char buf[((10-1-1-2) / 2) * BSIZE + 10] = {0};
        for (int i = 0; i < ((10-1-1-2) / 2) * BSIZE + 9; i++) {
            buf[i] = 'x';
        }
        printf("%s\n", buf);
        write(fd, buf, ((10-1-1-2) / 2) * BSIZE + 10);
        exit(0);
    }
    ```
    
    ![**begin_op()å’Œend_op()è¡¨ç¤ºä¸€æ¬¡å®Œæ•´çš„äº‹åŠ¡**](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2036.png)
    
    **begin_op()å’Œend_op()è¡¨ç¤ºä¸€æ¬¡å®Œæ•´çš„äº‹åŠ¡**
    
    å½“ç”¨æˆ·ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨å†™å…¥`((10-1-1-2) / 2) * BSIZE + 9` byteså†…å®¹æ—¶ï¼Œå¦‚æœwriteä¸­ä¸¤æ¬¡writeiéƒ½æˆåŠŸè¿›è¡Œï¼Œé‚£ä¹ˆä¸€åˆ‡æ­£å¸¸ï¼Œçœ‹ä¼¼èƒ½ä¿è¯ä¸€æ¬¡write syscallåŸå­æ€§
    
    ![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2037.png)
    
    ä½†æ˜¯å½“æˆ‘ä»¬æ¨¡æ‹Ÿåœ¨ç¬¬äºŒä¸ªchunkå†™å…¥ç£ç›˜å‰çªç„¶å‘ç”Ÿäº†crashï¼Œé‚£ä¹ˆç”¨æˆ·çš„è¿™æ¬¡writeä¼šæŒ‰é¢„æœŸå½“å½»åº•æ²¡å‘ç”Ÿè¿‡ä¸€æ ·å—ï¼Ÿä¸èƒ½
    
    ![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2038.png)
    
    ![Untitled](Xv6%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%20--%20%E7%BC%93%E5%AD%98%E5%92%8C%E5%90%8C%E6%AD%A5%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98%20c3def36c915c4faeaf5fda8dc18605f3/Untitled%2039.png)
    
    ## xv6æ—¥å¿—å®é™…ä¸Šéå¸¸ä½æ•ˆ
    
    Xv6çš„æ—¥å¿—ç³»ç»Ÿæ•ˆç‡ä½ä¸‹ã€‚æäº¤ä¸èƒ½ä¸æ–‡ä»¶ç³»ç»Ÿç³»ç»Ÿè°ƒç”¨åŒæ—¶å‘ç”Ÿã€‚ç³»ç»Ÿä¼šè®°å½•æ•´ä¸ªå—ï¼Œå³ä½¿ä¸€ä¸ªå—ä¸­åªæœ‰å‡ ä¸ªå­—èŠ‚è¢«æ”¹å˜ã€‚å®ƒæ‰§è¡ŒåŒæ­¥çš„æ—¥å¿—å†™å…¥ï¼Œä¸€æ¬¡å†™ä¸€ä¸ªå—ï¼Œæ¯ä¸€ä¸ªå—éƒ½å¯èƒ½éœ€è¦æ•´ä¸ªç£ç›˜æ—‹è½¬æ—¶é—´ã€‚çœŸæ­£çš„æ—¥å¿—ç³»ç»Ÿå¯ä»¥è§£å†³æ‰€æœ‰è¿™äº›é—®é¢˜ã€‚
    

# 3. Inode

<aside>
ğŸ’¡ ä¸€ä¸ªæ–‡ä»¶**å”¯ä¸€**å¯¹åº”ä¸€ä¸ªinode

</aside>