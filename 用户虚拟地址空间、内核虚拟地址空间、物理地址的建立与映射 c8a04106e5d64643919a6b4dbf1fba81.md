# ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ã€å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´ã€ç‰©ç†åœ°å€çš„å»ºç«‹ä¸æ˜ å°„

Status: Completed
æ¿å—: å†…å­˜ç®¡ç†, å¯åŠ¨

# ä¸€åˆ‡çš†ä¸ºè™šæ‹Ÿåœ°å€

RISC-VæŒ‡ä»¤(åŒ…æ‹¬**ç”¨æˆ·**å’Œ**å†…æ ¸**)æ“ä½œçš„æ˜¯**è™šæ‹Ÿåœ°å€**

å¯¹äº ç”¨æˆ·è¿›ç¨‹ æ¥è¯´ï¼Œå…¶æ“ä½œçš„æ˜¯è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´

å¯¹äº å†…æ ¸ è¿™ä¸ªç¨‹åºæ¥è¯´ï¼Œå…¶æ“ä½œçš„æ˜¯å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´

![å³ä¸Šè§’ç‚¹å‡»OriginalæŸ¥çœ‹åŸå›¾](%E7%94%A8%E6%88%B7%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E3%80%81%E5%86%85%E6%A0%B8%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E3%80%81%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80%E7%9A%84%E5%BB%BA%E7%AB%8B%E4%B8%8E%E6%98%A0%E5%B0%84%20c8a04106e5d64643919a6b4dbf1fba81/Untitled.png)

å³ä¸Šè§’ç‚¹å‡»OriginalæŸ¥çœ‹åŸå›¾

æˆ‘ä»¬çœ‹åˆ°è¿™å¼ å›¾ï¼š

1. æ€»å…±æœ‰ä¸‰ä¸ªåœ°å€ç©ºé—´å¸ƒå±€ï¼š(è¯¦è§£çœ‹å›¾)
    1. **æœ€ä¸­é—´**çš„åœ°å€ç©ºé—´æ˜¯**å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´**å¸ƒå±€ï¼šå®ƒä¹Ÿæ‹¥æœ‰ä¸€ä¸ª`0 ~ MAXVA`çš„è™šæ‹Ÿåœ°å€ç©ºé—´
        1. é¡¶éƒ¨çš„ä¸ºTrampoline å’Œ å†…æ ¸æ ˆ(in each process pbcï¼Œå½“è¿›ç¨‹åœ¨å†…æ ¸æ€æ‰§è¡Œä»£ç æ—¶ä½¿ç”¨è¯¥å†…æ ¸æ ˆ)
        2. å†…æ ¸ä½œä¸ºä¸€ä¸ªç¨‹åº/å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¢«BootLoaderåŠ è½½è¿›ç‰©ç†åœ°å€0x80000000å¤„ï¼Œç¨åç›´æ¥æ˜ å°„åˆ°å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´ã€KERNELBASE ï½ endæ˜¯å†…æ ¸æ•°æ®ã€ä»£ç æ®µã€‘
        3. åœ¨å†…æ ¸æ‰§è¡Œæ–‡ä»¶ç»“æŸåçš„ã€end~PHYSTOPåœ°å€ä¸ºç”¨æˆ·è¿›ç¨‹ã€å†…æ ¸é¡µ(by kalloc)ã€‘ç”³è¯·çš„åŒºåŸŸï¼Œç”±äºç›´æ¥æ˜ å°„ï¼Œè¿™éƒ¨åˆ†ç©ºé—´å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´ä¸ç‰©ç†å†…å­˜åœ°å€ä¸€è‡´
        4. è®¾å¤‡è¢«å®‰æ’åˆ°KERNELBASEä»¥ä¸‹çš„åœ°å€æ˜ å°„
    2. å¯¹äºæ¯ä¸ª**ç”¨æˆ·è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´**å¸ƒå±€æ˜¯**æœ€å·¦ä¾§**çš„ï¼š
        
        ä»0å¼€å§‹è£…è½½ç¨‹åºï¼Œtextã€dataã€stackã€heapã€trapframeã€trampolineï¼Œå…¶ä¸­æ¯ä¸ªç”¨æˆ·è¿›ç¨‹çš„trampolineå’Œå†…æ ¸åœ°å€ç©ºé—´çš„trampolineéƒ½æ˜¯åœ¨åŒä¸€ä¸ªè™šæ‹Ÿåœ°å€ç©ºé—´èŒƒå›´ä¸Š
        
    3. å¯¹äºè¿™å¼ è¡¨**æœ€å³ä¾§**çš„Physical Addressæ˜¯ç›´æ¥çš„**ç‰©ç†åœ°å€**ï¼š
        
        å›åˆ°æœ€åˆé‚£å¼ å›¾çš„å³ä¾§ï¼šç‰©ç†åœ°å€çš„åˆ†å¸ƒã€‚å¯ä»¥çœ‹åˆ°æœ€ä¸‹é¢æ˜¯æœªè¢«ä½¿ç”¨çš„åœ°å€ï¼Œè¿™ä¸ä¸»æ¿æ–‡æ¡£å†…å®¹æ˜¯ä¸€è‡´çš„ï¼ˆåœ°å€ä¸º0ï¼‰ã€‚åœ°å€0x1000æ˜¯boot ROMçš„ç‰©ç†åœ°å€ï¼Œå½“ä½ å¯¹ä¸»æ¿ä¸Šç”µï¼Œä¸»æ¿åšçš„ç¬¬ä¸€ä»¶äº‹æƒ…å°±æ˜¯è¿è¡Œå­˜å‚¨åœ¨boot ROMä¸­çš„ä»£ç ï¼Œå½“bootå®Œæˆä¹‹åï¼Œä¼šè·³è½¬åˆ°åœ°å€0x80000000ï¼Œæ“ä½œç³»ç»Ÿéœ€è¦ç¡®ä¿é‚£ä¸ªåœ°å€æœ‰ä¸€äº›æ•°æ®èƒ½å¤Ÿæ¥ç€å¯åŠ¨æ“ä½œç³»ç»Ÿã€‚
        
        ç‰©ç†åœ°å€`ä»0x80000000å¼€å§‹åˆ°PHYSTOP`ä¸ºå®ä½“ç‰©ç†å†…å­˜ç¡¬ä»¶ï¼Œè¿™ä¸ªèŒƒå›´åº”è¯¥æ˜¯å¼€æœºæ£€æµ‹è€Œå®šçš„å¤§å°ï¼Œä½†æˆ‘ä»¬è¿™é‡Œç®€ä¾¿æœŸé—´è§„å®šäº†
        
        PHYSTOPçš„å€¼ï¼Œè§„å®šäº†ç¡¬ä»¶å†…å­˜ç©ºé—´å¤§å°ã€‚ç‰©ç†åœ°å€ç©ºé—´å…¶å¤§éƒ¨åˆ†ç›´æ¥æ˜ å°„äºå†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚
        
        Xv6å®éªŒä¸­ï¼Œä½¿ç”¨QEMUå°†è®¾å¤‡æ¥å£ä½œä¸ºmemory-mapped(å†…å­˜æ˜ å°„)æ§åˆ¶å¯„å­˜å™¨ æš´éœ²ç»™è½¯ä»¶ï¼Œè¿™äº›å¯„å­˜å™¨ä½äºç‰©ç†åœ°å€ç©ºé—´çš„0x80000000ä»¥ä¸‹ã€‚å†…æ ¸å¯ä»¥é€šè¿‡è¯»å–/å†™å…¥è¿™äº›ç‰¹æ®Šçš„ç‰©ç†åœ°å€ä¸è®¾å¤‡è¿›è¡Œäº¤äº’ï¼›è¿™ç§è¯»å–å’Œå†™å…¥ä¸è®¾å¤‡ç¡¬ä»¶è€Œä¸æ˜¯ä¸RAMè¿›è¡Œé€šä¿¡ã€‚
        
2. æ˜ å°„ï¼š
    1. å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨å†…æ ¸å¯åŠ¨æ—¶å»ºç«‹ä¸ç‰©ç†å†…å­˜çš„è”ç³»ï¼Œå¤§å¤šæ•°ç©ºé—´éƒ½æ˜¯å†…æ ¸è™šæ‹Ÿåœ°å€ç›´æ¥æ˜ å°„ç¡¬ä»¶ç‰©ç†åœ°å€ï¼Œä½†é™¤äº†å†…æ ¸ç‰©ç†åœ°å€ç©ºé—´ä¸­çš„ä¸¤éƒ¨åˆ†ï¼š
        1. Trampoline
        2. å†…æ ¸æ ˆ Kernel Stacks
    2. å°†ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹åŠ è½½åˆ°ç‰©ç†å†…å­˜ä¸­æ¥ï¼Œå»ºç«‹ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´å¯¹ç‰©ç†å†…å­˜çš„ä½¿ç”¨ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå‘å†…æ ¸å‘å‡ºå†…å­˜çš„ç”³è¯·å†…å­˜é¡µï¼Œå†…æ ¸åœ¨å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´çš„`kernelç»“æŸå~PHYSTOP`èŒƒå›´å†…ç”³è¯·Pageså°†å…¶æ˜ å°„ç»™ç”¨æˆ·è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œç”±äºå†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´åœ¨å†…æ ¸åˆå§‹åŒ–æ—¶å·²ç»æ˜ å°„äº†ç‰©ç†å†…å­˜ï¼Œå› æ­¤è¿™é‡Œç›¸å½“äºç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´é€šè¿‡å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´é—´æ¥ä½¿ç”¨äº†ç‰©ç†åœ°å€ç©ºé—´

# å»ºç«‹ å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´ æ˜ å°„ã€å¼€å¯åˆ†é¡µ

![Untitled](%E7%94%A8%E6%88%B7%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E3%80%81%E5%86%85%E6%A0%B8%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E3%80%81%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80%E7%9A%84%E5%BB%BA%E7%AB%8B%E4%B8%8E%E6%98%A0%E5%B0%84%20c8a04106e5d64643919a6b4dbf1fba81/Untitled%201.png)

![Untitled](%E7%94%A8%E6%88%B7%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E3%80%81%E5%86%85%E6%A0%B8%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E3%80%81%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80%E7%9A%84%E5%BB%BA%E7%AB%8B%E4%B8%8E%E6%98%A0%E5%B0%84%20c8a04106e5d64643919a6b4dbf1fba81/Untitled%202.png)

å»ºç«‹ç©ºé—²é¡µé“¾è¡¨è¿™æ ·çš„æ•°æ®ç»“æ„ä¾›ç”³è¯·ä½¿ç”¨

![Untitled](%E7%94%A8%E6%88%B7%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E3%80%81%E5%86%85%E6%A0%B8%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E3%80%81%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80%E7%9A%84%E5%BB%BA%E7%AB%8B%E4%B8%8E%E6%98%A0%E5%B0%84%20c8a04106e5d64643919a6b4dbf1fba81/Untitled%203.png)

![Untitled](%E7%94%A8%E6%88%B7%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E3%80%81%E5%86%85%E6%A0%B8%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E3%80%81%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80%E7%9A%84%E5%BB%BA%E7%AB%8B%E4%B8%8E%E6%98%A0%E5%B0%84%20c8a04106e5d64643919a6b4dbf1fba81/Untitled%204.png)

åœ¨ä¸Šè¿°[è¿™å¼ å›¾](%E7%94%A8%E6%88%B7%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E3%80%81%E5%86%85%E6%A0%B8%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E3%80%81%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80%E7%9A%84%E5%BB%BA%E7%AB%8B%E4%B8%8E%E6%98%A0%E5%B0%84%20c8a04106e5d64643919a6b4dbf1fba81.md)ä¸­æˆ‘ä»¬çœ‹åˆ°ä¸­é—´çš„å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´**ç›´æ¥æ˜ å°„**åˆ°ç‰©ç†åœ°å€ç©ºé—´åœ°å€çš„æƒ…å†µå°±æ˜¯åœ¨è¿™é‡Œå®ç°æ“ä½œçš„ï¼Œè¿™é‡Œå»ºç«‹äº†å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´(é¡µè¡¨) `kernel_pagetable`

![Untitled](%E7%94%A8%E6%88%B7%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E3%80%81%E5%86%85%E6%A0%B8%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E3%80%81%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80%E7%9A%84%E5%BB%BA%E7%AB%8B%E4%B8%8E%E6%98%A0%E5%B0%84%20c8a04106e5d64643919a6b4dbf1fba81/Untitled%205.png)

æ¥ä¸‹æ¥å¼€å¯åˆ†é¡µæœºåˆ¶å°†å†…æ ¸è·Ÿé¡µè¡¨ç‰©ç†åœ°å€å¡«å…¥satpå¯„å­˜å™¨(æ ¹é¡µè¡¨å¯„å­˜å™¨)å¹¶åˆ·æ–°TLBï¼Œ

è‡³æ­¤ï¼Œæˆ‘ä»¬å°±èƒ½è®©ç”¨æˆ·è¿›ç¨‹ä½¿ç”¨å†…æ ¸é¡µè¡¨äº†ï¼Ÿï¼Ÿï¼Ÿ// TODO

# ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´

å½“è¿›å…¥åˆ°ç”¨æˆ·æ¨¡å¼æ—¶ï¼Œæˆ‘ä»¬å°†å†…æ ¸é¡µè¡¨çš„æ ¹åœ°å€æ”¾å…¥`p->trapframe->kernel_pagetable`ä¸­ï¼Œå½“å†æ¬¡è¿›å…¥å†…æ ¸æ€ï¼Œæˆ‘ä»¬å†å°†satpå¯„å­˜å™¨è®¾ç½®ä¸º`p->trapframe->kernel_pagetable`çš„å€¼ã€‚(trap.c trampoline.S)

![å‡ºå†…æ ¸è¿›ç”¨æˆ·ç©ºé—´](%E7%94%A8%E6%88%B7%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E3%80%81%E5%86%85%E6%A0%B8%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E3%80%81%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80%E7%9A%84%E5%BB%BA%E7%AB%8B%E4%B8%8E%E6%98%A0%E5%B0%84%20c8a04106e5d64643919a6b4dbf1fba81/%E5%9B%BE%E7%89%876.png)

å‡ºå†…æ ¸è¿›ç”¨æˆ·ç©ºé—´

![è¿›å†…æ ¸](%E7%94%A8%E6%88%B7%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E3%80%81%E5%86%85%E6%A0%B8%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E3%80%81%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80%E7%9A%84%E5%BB%BA%E7%AB%8B%E4%B8%8E%E6%98%A0%E5%B0%84%20c8a04106e5d64643919a6b4dbf1fba81/%E5%9B%BE%E7%89%877.png)

è¿›å†…æ ¸

[ç‰©ç†å†…å­˜å¦‚ä½•ç»„ç»‡ç®¡ç†ä»¥ä¾›ä½¿ç”¨](%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E5%A6%82%E4%BD%95%E7%BB%84%E7%BB%87%E7%AE%A1%E7%90%86%E4%BB%A5%E4%BE%9B%E4%BD%BF%E7%94%A8%20c67d1d2715144ac9a47c0665b92b4f81.md) 

<aside>
ğŸ’¡ ä¸‹ä¸€å›:

[åˆ†é¡µæœºåˆ¶](%E5%88%86%E9%A1%B5%E6%9C%BA%E5%88%B6%200c97caa5ff76434b89f8e4d1c363d987.md)

</aside>